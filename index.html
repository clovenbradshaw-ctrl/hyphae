<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EO Project Manager</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root[data-theme="dark"] {
      --bg-primary:#0f0f0f; --bg-secondary:#1a1a1a; --bg-tertiary:#252525; --bg-hover:#2a2a2a;
      --border:#333; --border-light:#404040; --text-primary:#f5f5f5; --text-secondary:#b4b4b4; 
      --text-tertiary:#757575; --accent:#3b82f6; --accent-hover:#2563eb; --accent-light:#1e40af;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --purple:#a855f7; --card-shadow:0 1px 3px rgba(0,0,0,.3);
    }
    :root[data-theme="light"] {
      --bg-primary:#fff; --bg-secondary:#f9fafb; --bg-tertiary:#f3f4f6; --bg-hover:#e5e7eb;
      --border:#e5e7eb; --border-light:#f3f4f6; --text-primary:#111827; --text-secondary:#6b7280; 
      --text-tertiary:#9ca3af; --accent:#3b82f6; --accent-hover:#2563eb; --accent-light:#60a5fa;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --purple:#a855f7; --card-shadow:0 1px 3px rgba(0,0,0,.1);
    }
    
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden;font-size:14px;line-height:1.5}
    
    /* Layout */
    .app{display:flex;height:100vh}
    .sidebar{width:240px;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    
    /* Sidebar */
    .logo{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .logo-text{font-size:16px;font-weight:700;color:var(--text-primary)}
    .nav{padding:12px 8px;overflow:auto;flex:1}
    .nav-section{margin-bottom:24px}
    .nav-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-tertiary);padding:0 12px 8px;display:flex;align-items:center;justify-content:space-between}
    .nav-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;margin:2px 0;cursor:pointer;color:var(--text-secondary);border-radius:6px;transition:all .15s;font-size:14px}
    .nav-item:hover{background:var(--bg-hover);color:var(--text-primary)}
    .nav-item.active{background:var(--accent);color:#fff;font-weight:500}
    .nav-item.active .badge{background:rgba(255,255,255,.2);color:#fff}
    .badge{font-size:12px;background:var(--bg-tertiary);color:var(--text-tertiary);padding:2px 8px;border-radius:12px;font-weight:500;min-width:24px;text-align:center}
    
    /* Header */
    .header{height:60px;background:var(--bg-primary);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
    .header-left{display:flex;align-items:center;gap:16px}
    .header-title{font-size:18px;font-weight:600;color:var(--text-primary)}
    .view-toggle{display:flex;gap:4px;background:var(--bg-secondary);padding:4px;border-radius:8px}
    .view-toggle .btn{background:transparent;border:none;padding:6px 12px;font-size:13px}
    .view-toggle .btn.active{background:var(--bg-primary);box-shadow:var(--card-shadow)}
    
    /* Buttons */
    .btn{padding:8px 16px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:var(--bg-hover);border-color:var(--border-light)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.primary:hover{background:var(--accent-hover)}
    .btn.sm{padding:6px 12px;font-size:13px}
    .btn.ghost{background:transparent;border:none}
    .btn.ghost:hover{background:var(--bg-hover)}
    .btn.icon{padding:6px;width:32px;height:32px;justify-content:center}
    
    /* Content area */
    .content{flex:1;overflow:auto;padding:24px;background:var(--bg-secondary)}
    
    /* Board */
    .board{display:flex;gap:16px;overflow:auto;padding-bottom:16px;min-height:100%;align-items:flex-start}
    .column{flex:0 0 320px;min-width:320px;background:var(--bg-tertiary);border-radius:8px;display:flex;flex-direction:column;max-height:calc(100vh - 140px)}
    .column-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .column-title{font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);display:flex;align-items:center;gap:8px}
    .column-count{font-size:13px;color:var(--text-tertiary);font-weight:500}
    .column-body{padding:12px;display:flex;flex-direction:column;gap:10px;overflow:auto;flex:1}
    
    /* Cards */
    .card{background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;padding:14px;cursor:pointer;transition:all .2s;box-shadow:var(--card-shadow)}
    .card:hover{border-color:var(--accent-light);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .card.ready{border-left:3px solid var(--success)}
    .card-id{font-size:12px;color:var(--text-tertiary);font-weight:500;margin-bottom:6px}
    .card-title{font-size:15px;font-weight:500;color:var(--text-primary);margin-bottom:10px;line-height:1.4}
    .card-meta{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .pill{font-size:12px;padding:4px 10px;background:var(--bg-tertiary);border-radius:4px;color:var(--text-secondary);font-weight:500;display:inline-flex;align-items:center;gap:4px}
    .pill.ready{background:var(--success);color:#fff}
    .pill.status-todo{background:#f59e0b22;color:var(--warning)}
    .pill.status-doing{background:#3b82f622;color:var(--accent)}
    .pill.status-done{background:#10b98122;color:var(--success)}
    
    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:24px;z-index:100}
    .overlay.active{display:flex}
    .modal{width:min(960px,100%);max-height:90vh;background:var(--bg-primary);border-radius:12px;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.4);overflow:hidden}
    .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .modal-title{font-size:18px;font-weight:600;color:var(--text-primary)}
    .modal-body{padding:24px;overflow:auto;flex:1}
    .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end;flex-shrink:0;background:var(--bg-secondary)}
    
    /* Modal sections */
    .section{background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
    .section:last-child{margin-bottom:0}
    .section-header{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-tertiary);margin-bottom:12px}
    .section-content{color:var(--text-primary)}
    .info-grid{display:grid;gap:16px}
    .info-row{display:flex;align-items:flex-start;gap:12px}
    .info-row.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .info-label{font-size:12px;color:var(--text-tertiary);font-weight:500;margin-bottom:4px}
    .info-value{font-size:14px;color:var(--text-primary)}
    
    /* Form elements */
    .input,select.input{padding:10px 12px;width:100%;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:14px;transition:all .15s}
    .input:focus,select.input:focus{outline:none;border-color:var(--accent);background:var(--bg-primary)}
    .input::placeholder{color:var(--text-tertiary)}
    
    /* Timeline */
    .timeline{display:flex;flex-direction:column;gap:12px}
    .timeline-item{display:flex;gap:12px;padding:12px;background:var(--bg-tertiary);border-radius:6px}
    .timeline-item.highlight{border-left:3px solid var(--accent)}
    .timeline-time{font-size:12px;color:var(--text-tertiary);white-space:nowrap;min-width:60px}
    .timeline-content{flex:1}
    .timeline-actor{color:var(--accent);font-weight:600;font-size:13px}
    .timeline-desc{color:var(--text-secondary);font-size:13px}
    
    /* List view */
    .list-container{background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;overflow:hidden}
    .list-header{display:grid;grid-template-columns:100px 1fr 180px 140px 100px;gap:16px;padding:12px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.05em}
    .list-row{display:grid;grid-template-columns:100px 1fr 180px 140px 100px;gap:16px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;align-items:center}
    .list-row:last-child{border-bottom:none}
    .list-row:hover{background:var(--bg-hover)}
    .list-cell{font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .list-cell.id{color:var(--text-tertiary);font-weight:500}
    .list-cell.title{color:var(--text-primary);font-weight:500}
    .list-cell.meta{color:var(--text-secondary)}
    
    /* Empty state */
    .empty-state{text-align:center;padding:60px 24px;color:var(--text-tertiary)}
    .empty-state-icon{font-size:48px;margin-bottom:16px;opacity:.5}
    .empty-state-title{font-size:16px;font-weight:600;color:var(--text-secondary);margin-bottom:8px}
    .empty-state-text{font-size:14px}
    
    /* Checkpoint list */
    .checkpoint-list{display:flex;flex-direction:column;gap:10px}
    .checkpoint-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-tertiary);border-radius:6px}
    .checkpoint-status{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
    .checkpoint-status.met{background:var(--success);color:#fff}
    .checkpoint-status.unmet{background:var(--bg-secondary);border:2px solid var(--border);color:var(--text-tertiary)}
    .checkpoint-info{flex:1}
    .checkpoint-text{font-size:14px;color:var(--text-primary);font-weight:500;margin-bottom:2px}
    .checkpoint-evidence{font-size:12px;color:var(--text-tertiary)}
    
    /* Artifacts */
    .artifact-list{display:flex;flex-direction:column;gap:8px}
    .artifact-item{display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg-tertiary);border-radius:6px}
    .artifact-icon{font-size:20px}
    .artifact-info{flex:1}
    .artifact-name{font-size:14px;color:var(--text-primary);font-weight:500}
    .artifact-meta{font-size:12px;color:var(--text-tertiary)}
    
    /* Role/Workflow display */
    .detail-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .detail-card{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:16px}
    .detail-card-title{font-size:15px;font-weight:600;color:var(--text-primary);margin-bottom:12px}
    .detail-card-content{color:var(--text-secondary);font-size:14px}
    .workflow-chain{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:12px}
    .workflow-step{padding:8px 14px;background:var(--bg-secondary);border-radius:6px;font-size:13px;font-weight:500}
    .workflow-arrow{color:var(--text-tertiary)}
    
    /* Utilities */
    .row{display:flex;gap:12px;align-items:center}
    .space-between{justify-content:space-between}
    .mt-1{margin-top:8px}
    .mt-2{margin-top:16px}
    .text-sm{font-size:13px}
    .text-xs{font-size:12px}
    .font-semibold{font-weight:600}
    .text-muted{color:var(--text-secondary)}
    
    /* Scrollbar */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:var(--text-tertiary)}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-text">EVENT_OPERATOR</div>
        <button class="btn icon ghost" id="themeToggle" title="Toggle theme">🌙</button>
      </div>
      <nav class="nav" id="navRoot">
        <div class="nav-section">
          <div class="nav-label">VIEWS</div>
          <div class="nav-item" data-view="status"><span>My Board</span><span class="badge" id="statusCount">0</span></div>
          <div class="nav-item" data-view="tasks"><span>All Tasks</span><span class="badge" id="allTasksCount">0</span></div>
          <div class="nav-item" data-view="roles"><span>Roles</span><span class="badge" id="rolesCount">0</span></div>
          <div class="nav-item" data-view="workflows"><span>Workflows</span><span class="badge" id="workflowsCount">0</span></div>
        </div>
        <div class="nav-section">
          <div class="nav-label">BY ROLE</div>
          <div id="roleNavItems"></div>
        </div>
        <div class="nav-section">
          <div class="nav-label">BY WORKFLOW</div>
          <div id="workflowNavItems"></div>
        </div>
      </nav>
    </aside>
    
    <main class="main">
      <div class="header">
        <div class="header-left">
          <div class="header-title" id="viewTitle">My Board</div>
        </div>
        <div class="row">
          <div class="view-toggle">
            <button class="btn sm active" data-layout="board">Board</button>
            <button class="btn sm" data-layout="list">List</button>
          </div>
          <button class="btn sm" id="newCheckpoint">+ Checkpoint</button>
          <button class="btn primary sm" id="newTask">+ New Task</button>
        </div>
      </div>
      <section class="content" id="main"></section>
    </main>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">#TASK</div>
        <button class="btn icon ghost" id="closeModal">✕</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button class="btn" id="overrideBtn">Override & Move</button>
        <button class="btn primary" id="moveBtn">Mark Ready & Move</button>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // Storage & Event Sourcing
    // =============================
    const STORAGE_KEY = 'eo_pm_eventstore_v03';
    const eventStore = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(eventStore)); }

    function recordEvent(evt){
      const e = { id: 'evt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8), ts: Date.now(), v:3, ...evt };
      eventStore.push(e); persist();
      return e;
    }

    function op(opcode){ return opcode; }

    // =============================
    // Data Model
    // =============================
    const operators = [
      {id:'starter',name:'Starter'}, {id:'connector',name:'Connector'}, {id:'coordinator',name:'Coordinator'},
      {id:'doer',name:'Doer'}, {id:'reviewer',name:'Reviewer'}, {id:'documenter',name:'Documenter'},
      {id:'approver',name:'Approver'}, {id:'steward',name:'Steward'}, {id:'convener',name:'Convener'}
    ];

    const roles = {
      'content-writer': { id:'content-writer', name:'Content Writer', operator:'doer', people:['alex','sam'], power:{institutional:1,epistemic:2,action:2,narrative:2} },
      'sm-reviewer': { id:'sm-reviewer', name:'SM Reviewer', operator:'reviewer', people:['pat'], power:{institutional:2,epistemic:3,action:1,narrative:2} },
      'sm-approver': { id:'sm-approver', name:'SM Approver', operator:'approver', people:['casey'], power:{institutional:3,epistemic:2,action:3,narrative:2} }
    };

    const workflows = {
      'social-media': {
        id:'social-media', name:'Social Media Creation', frame_id:'content_ops_quarterly',
        description:'How we create social media content',
        chain:[
          { role:'content-writer', handoff_rules:[
              { id:'has_draft', text:'Draft complete', auto_detect:(t)=>t.artifacts.some(a=>/draft/i.test(a.name)) },
              { id:'has_images', text:'Has images', auto_detect:(t)=>t.artifacts.some(a=>a.type==='image') }
          ]},
          { role:'sm-reviewer', handoff_rules:[ { id:'review_complete', text:'Review complete', auto_detect:null } ] },
          { role:'sm-approver', handoff_rules:[ { id:'approved', text:'Approved for publish', auto_detect:null } ] }
        ]
      }
    };

    // =============================
    // Seed Data
    // =============================
    if(eventStore.length===0){
      recordEvent({ type:'task_created', task_id:'TASK-001', title:'Housing blog post', workflow:'social-media', initial_role:'content-writer', actor:'alex', ops:[op('DES'),op('INS')] });
      recordEvent({ type:'task_status_set', task_id:'TASK-001', status:'todo', prev_status:null, actor:'alex', ops:[op('ALT')] });
      recordEvent({ type:'task_created', task_id:'TASK-002', title:'Climate action post', workflow:'social-media', initial_role:'content-writer', actor:'alex', ops:[op('DES'),op('INS')] });
      recordEvent({ type:'task_status_set', task_id:'TASK-002', status:'doing', prev_status:'todo', actor:'alex', ops:[op('ALT')] });
      recordEvent({ type:'artifact_added', task_id:'TASK-002', artifact_name:'draft.md', artifact_type:'document', actor:'alex', ops:[op('INS')] });
      recordEvent({ type:'artifact_added', task_id:'TASK-002', artifact_name:'climate-graph.png', artifact_type:'image', actor:'alex', ops:[op('INS')] });
      recordEvent({ type:'checkpoint_detected', task_id:'TASK-002', checkpoint:'has_draft', evidence:'draft.md attached', source:'auto', ops:[op('SEG')] });
      recordEvent({ type:'checkpoint_detected', task_id:'TASK-002', checkpoint:'has_images', evidence:'1 image attached', source:'auto', ops:[op('SEG')] });
      recordEvent({ type:'task_created', task_id:'TASK-003', title:'Mutual aid guide', workflow:'social-media', initial_role:'content-writer', actor:'sam', ops:[op('DES'),op('INS')] });
      recordEvent({ type:'task_status_set', task_id:'TASK-003', status:'doing', prev_status:'todo', actor:'sam', ops:[op('ALT')] });
      recordEvent({ type:'artifact_added', task_id:'TASK-003', artifact_name:'guide-draft.md', artifact_type:'document', actor:'sam', ops:[op('INS')] });
      recordEvent({ type:'role_transitioned', task_id:'TASK-003', from_role:'content-writer', to_role:'sm-reviewer', actor:'sam', ops:[op('CON')] });
      recordEvent({ type:'task_created', task_id:'TASK-004', title:'Community calendar', workflow:'social-media', initial_role:'content-writer', actor:'jordan', ops:[op('DES'),op('INS')] });
      recordEvent({ type:'task_status_set', task_id:'TASK-004', status:'done', prev_status:'doing', actor:'jordan', ops:[op('ALT')] });
      recordEvent({ type:'artifact_added', task_id:'TASK-004', artifact_name:'calendar-final.md', artifact_type:'document', actor:'jordan', ops:[op('INS')] });
      recordEvent({ type:'role_transitioned', task_id:'TASK-004', from_role:'content-writer', to_role:'sm-reviewer', actor:'jordan', ops:[op('CON')] });
      recordEvent({ type:'checkpoint_detected', task_id:'TASK-004', checkpoint:'review_complete', evidence:'Reviewer marked complete', source:'manual', ops:[op('SEG')] });
      recordEvent({ type:'role_transitioned', task_id:'TASK-004', from_role:'sm-reviewer', to_role:'sm-approver', actor:'pat', ops:[op('CON')] });
    }

    // =============================
    // Projections
    // =============================
    function taskIds(){ const s=new Set(); eventStore.forEach(e=>e.task_id && s.add(e.task_id)); return [...s]; }

    function project(taskId){
      const events = eventStore.filter(e=>e.task_id===taskId).sort((a,b)=>a.ts-b.ts);
      const state = { id:taskId, title:'', workflow:null, frame_id:null, current_role:null, status:'todo', artifacts:[], checkpoints:{}, timeline:[] };
      for(const e of events){
        if(e.type==='task_created'){ state.title=e.title; state.workflow=e.workflow; state.frame_id=workflows[e.workflow]?.frame_id||null; state.current_role=e.initial_role; }
        if(e.type==='artifact_added'){ state.artifacts.push({name:e.artifact_name, type:e.artifact_type, added_by:e.actor, added_at:e.ts}); }
        if(e.type==='role_transitioned'){ state.current_role=e.to_role; }
        if(e.type==='checkpoint_detected'){ state.checkpoints[e.checkpoint] = { met:true, evidence:e.evidence, source:e.source||'manual' }; }
        if(e.type==='checkpoint_cleared'){ delete state.checkpoints[e.checkpoint]; }
        if(e.type==='task_status_set'){ state.status=e.status; }
        state.timeline.push({ ts:e.ts, type:e.type, who:e.actor||'system', desc:describe(e) });
      }
      return state;
    }

    function describe(e){
      switch(e.type){
        case 'task_created': return `created task "${e.title}"`;
        case 'artifact_added': return `added ${e.artifact_name}`;
        case 'role_transitioned': return `moved to ${roles[e.to_role]?.name||e.to_role}`;
        case 'checkpoint_detected': return `checkpoint "${e.checkpoint}" met`;
        case 'checkpoint_cleared': return `checkpoint "${e.checkpoint}" cleared`;
        case 'ready_marked': return `marked ready`;
        case 'override_move': return `override move → ${roles[e.to_role]?.name||e.to_role} (reason: ${e.reason})`;
        case 'task_status_set': return `status → ${e.status}`;
        default: return e.type;
      }
    }

    function tasksAtRole(roleId){ return taskIds().map(project).filter(t=>t.current_role===roleId); }
    function tasksInWorkflow(wfId){ return taskIds().map(project).filter(t=>t.workflow===wfId); }

    function isReady(task){
      const wf = workflows[task.workflow]; if(!wf) return false;
      const idx = wf.chain.findIndex(s=>s.role===task.current_role); if(idx<0) return false;
      const step = wf.chain[idx]; if(!step.handoff_rules || step.handoff_rules.length===0) return true;
      return step.handoff_rules.every(rule => rule.auto_detect ? !!rule.auto_detect(task) : !!task.checkpoints[rule.id]);
    }

    // =============================
    // Rendering
    // =============================
    const LAYOUT_STORAGE_KEY = 'eo_pm_layout_pref_v1';
    const layoutPrefs = JSON.parse(localStorage.getItem(LAYOUT_STORAGE_KEY) || '{}');

    let currentView = { type:'status' };
    let layout = getLayoutForView(currentView.type);

    function viewSupportsList(type){
      return ['tasks','role','workflow'].includes(type);
    }

    function getLayoutForView(type){
      if(!viewSupportsList(type)) return 'board';
      const saved = layoutPrefs[type];
      return saved === 'list' ? 'list' : 'board';
    }

    function saveLayoutPreference(viewType, value){
      if(!viewSupportsList(viewType)) return;
      layoutPrefs[viewType] = value;
      localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layoutPrefs));
    }

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function render(){
      updateNavCounts();
      updateViewTitle();
      updateViewToggle();
      if(currentView.type==='status'){ return renderStatusBoard(); }
      if(currentView.type==='tasks'){ return layout==='list' ? renderAllTasksList() : renderAllTasksBoard(); }
      if(currentView.type==='roles'){ return renderRoles(); }
      if(currentView.type==='workflows'){ return renderWorkflows(); }
      if(currentView.type==='role'){ return layout==='list' ? renderRoleList(currentView.id) : renderRoleBoard(currentView.id); }
      if(currentView.type==='workflow'){ return layout==='list' ? renderWorkflowList(currentView.id) : renderWorkflowBoard(currentView.id); }
      return renderAllTasksBoard();
    }

    function updateViewTitle(){
      const titles = {
        'status': 'My Board',
        'tasks': 'All Tasks',
        'roles': 'Roles',
        'workflows': 'Workflows',
        'role': roles[currentView.id]?.name || 'Role',
        'workflow': workflows[currentView.id]?.name || 'Workflow'
      };
      $('#viewTitle').textContent = titles[currentView.type] || 'View';
    }

    function updateNavCounts(){
      $('#allTasksCount').textContent = taskIds().length;
      $('#statusCount').textContent = taskIds().length;
      $('#rolesCount').textContent = Object.keys(roles).length;
      $('#workflowsCount').textContent = Object.keys(workflows).length;
      
      const roleHTML = Object.values(roles).map(r=>{
        const count = tasksAtRole(r.id).length;
        return `<div class="nav-item" data-view="role" data-role="${r.id}"><span>${r.name}</span><span class="badge">${count}</span></div>`;
      }).join('');
      $('#roleNavItems').innerHTML = roleHTML || '<div class="empty-state"><div class="empty-state-text">No roles</div></div>';
      
      const wfHTML = Object.values(workflows).map(wf=>{
        const count = tasksInWorkflow(wf.id).length;
        return `<div class="nav-item" data-view="workflow" data-workflow="${wf.id}"><span>${wf.name}</span><span class="badge">${count}</span></div>`;
      }).join('');
      $('#workflowNavItems').innerHTML = wfHTML || '<div class="empty-state"><div class="empty-state-text">No workflows</div></div>';
      
      attachNavListeners();
    }

    function card(task, showWorkflow=false, showRole=false){
      const ready = isReady(task);
      const wf = workflows[task.workflow];
      const role = roles[task.current_role];
      
      return `<div class="card ${ready?'ready':''}" data-open="${task.id}" draggable="true">
        <div class="card-id">${task.id}</div>
        <div class="card-title">${task.title}</div>
        <div class="card-meta">
          ${showWorkflow?`<span class="pill">${wf?.name||task.workflow}</span>`:''}
          ${showRole?`<span class="pill">${role?.name||task.current_role}</span>`:''}
          <span class="pill status-${task.status}">${task.status}</span>
          ${task.artifacts.length>0?`<span class="pill">${task.artifacts.length} ${task.artifacts.length===1?'file':'files'}</span>`:''}
          ${ready?`<span class="pill ready">✓ Ready</span>`:''}
        </div>
      </div>`;
    }

    function renderStatusBoard(){
      const all = taskIds().map(project);
      const todo = all.filter(t => t.status === 'todo');
      const doing = all.filter(t => t.status === 'doing');
      const done = all.filter(t => t.status === 'done');
      
      const cols = [
        { name: 'To Do', tasks: todo, status: 'todo' },
        { name: 'In Progress', tasks: doing, status: 'doing' },
        { name: 'Completed', tasks: done, status: 'done' }
      ].map(col => `
        <div class="column">
          <div class="column-header">
            <div class="column-title">${col.name}</div>
            <div class="column-count">${col.tasks.length}</div>
          </div>
          <div class="column-body" data-drop-status="${col.status}">
            ${col.tasks.length ? col.tasks.map(t => card(t, true, true)).join('') : '<div class="empty-state"><div class="empty-state-icon">📋</div><div class="empty-state-text">No tasks</div></div>'}
          </div>
        </div>
      `).join('');
      
      $('#main').innerHTML = `<div class="board">${cols}</div>`;
      enableStatusDragDrop();
      bindOpen();
    }

    function renderAllTasksBoard(){
      const all = taskIds().map(project);
      $('#main').innerHTML = `<div class="board"><div class="column" style="flex:1;max-width:100%"><div class="column-header"><div class="column-title">All Tasks</div><div class="column-count">${all.length}</div></div><div class="column-body">${all.map(t=>card(t,true,true)).join('')}</div></div></div>`;
      bindOpen();
    }

    function renderRoleBoard(roleId){
      const list = tasksAtRole(roleId);
      const role = roles[roleId];
      const op = operators.find(o=>o.id===role?.operator);
      $('#main').innerHTML = `<div class="board"><div class="column" style="flex:1;max-width:100%"><div class="column-header"><div class="column-title">${role?.name||roleId} <span style="opacity:.6">· ${op?.name||''}</span></div><div class="column-count">${list.length}</div></div><div class="column-body">${list.length?list.map(t=>card(t,true)).join(''):'<div class="empty-state"><div class="empty-state-icon">📋</div><div class="empty-state-text">No tasks</div></div>'}</div></div></div>`;
      bindOpen();
    }

    function renderWorkflowBoard(workflowId){
      const wf = workflows[workflowId];
      if(!wf){
        $('#main').innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-text">Workflow not found</div></div>';
        return;
      }
      const tasks = tasksInWorkflow(wf.id);
      const cols = wf.chain.map(step=>{
        const r = roles[step.role];
        const rs = tasks.filter(t=>t.current_role===step.role);
        const op = operators.find(o=>o.id===r?.operator);
        return `<div class="column"><div class="column-header"><div class="column-title">${r?.name||step.role} <span style="opacity:.6">· ${op?.name||''}</span></div><div class="column-count">${rs.length}</div></div><div class="column-body" data-drop="${step.role}">${rs.length?rs.map(t=>card(t)).join(''):'<div class="empty-state"><div class="empty-state-icon">📋</div><div class="empty-state-text">No tasks</div></div>'}</div></div>`;
      }).join('');
      $('#main').innerHTML = `<div class="board">${cols}</div>`;
      enableDragDrop();
      bindOpen();
    }

    function buildListRows(tasks, cellBuilder){
      return tasks.map(t=>{
        const cells = cellBuilder(t);
        const cols = cells.map(cell=>`<div class="list-cell ${cell.className||''}">${cell.content}</div>`).join('');
        return `<div class="list-row" data-open="${t.id}">${cols}</div>`;
      });
    }

    function renderListView(headers, rows){
      const headerHtml = `<div class="list-header">${headers.map(h=>`<div>${h}</div>`).join('')}</div>`;
      const rowsHtml = rows.length ? rows.join('') : '<div class="empty-state"><div class="empty-state-icon">📋</div><div class="empty-state-text">No tasks</div></div>';
      $('#main').innerHTML = `<div class="list-container">${headerHtml}${rowsHtml}</div>`;
      bindOpen();
    }

    function renderAllTasksList(){
      const tasks = taskIds().map(project);
      const rows = buildListRows(tasks, t=>{
        const wf=workflows[t.workflow], role=roles[t.current_role];
        return [
          { className:'id', content:t.id },
          { className:'title', content:t.title },
          { className:'meta', content:wf?.name||t.workflow },
          { className:'meta', content:role?.name||t.current_role },
          { content:`<span class="pill status-${t.status}">${t.status}</span>` }
        ];
      });
      renderListView(['ID','Title','Workflow','Role','Status'], rows);
    }

    function renderRoleList(roleId){
      const tasks = tasksAtRole(roleId);
      const rows = buildListRows(tasks, t=>{
        const wf=workflows[t.workflow];
        const ready = isReady(t);
        return [
          { className:'id', content:t.id },
          { className:'title', content:t.title },
          { className:'meta', content:wf?.name||t.workflow },
          { className:'meta', content:`<span class="pill status-${t.status}">${t.status}</span>` },
          { className:'meta', content:ready?'<span class="pill ready">✓ Ready</span>':'<span class="text-muted">Not ready</span>' }
        ];
      });
      renderListView(['ID','Title','Workflow','Status','Ready'], rows);
    }

    function renderWorkflowList(workflowId){
      const wf = workflows[workflowId];
      if(!wf){
        $('#main').innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-text">Workflow not found</div></div>';
        return;
      }
      const tasks = tasksInWorkflow(workflowId);
      const rows = buildListRows(tasks, t=>{
        const role = roles[t.current_role];
        const ready = isReady(t);
        return [
          { className:'id', content:t.id },
          { className:'title', content:t.title },
          { className:'meta', content:role?.name||t.current_role },
          { className:'meta', content:`<span class="pill status-${t.status}">${t.status}</span>` },
          { className:'meta', content:ready?'<span class="pill ready">✓ Ready</span>':'<span class="text-muted">Not ready</span>' }
        ];
      });
      renderListView(['ID','Title','Role','Status','Ready'], rows);
    }

    function renderRoles(){
      const blocks = operators.map(op=>{
        const rs = Object.values(roles).filter(r=>r.operator===op.id);
        return rs.map(r=>{
          const ppl = r.people.map(p=>`<span class="pill">${p}</span>`).join('');
          const pv = r.power?`<div class="text-xs text-muted mt-1">Power: I${r.power.institutional} E${r.power.epistemic} A${r.power.action} N${r.power.narrative}</div>`:'';
          return `<div class="detail-card"><div class="detail-card-title">${r.name}</div><div class="text-sm text-muted">${op.name}</div><div class="row mt-1">${ppl}</div>${pv}</div>`;
        }).join('');
      }).join('');
      $('#main').innerHTML = `<div class="detail-grid">${blocks||'<div class="empty-state"><div class="empty-state-icon">👥</div><div class="empty-state-title">No roles yet</div></div>'}</div>`;
    }

    function renderWorkflows(){
      const blocks = Object.values(workflows).map(wf=>{
        const steps = wf.chain.map((s,i)=>{
          const r = roles[s.role];
          return `<div class="workflow-step">${r?.name||s.role}</div>${i<wf.chain.length-1?'<div class="workflow-arrow">→</div>':''}`;
        }).join('');
        return `<div class="detail-card"><div class="detail-card-title">${wf.name}</div><div class="text-sm text-muted">${wf.description||''}</div><div class="workflow-chain">${steps}</div></div>`;
      }).join('');
      $('#main').innerHTML = `<div class="detail-grid">${blocks||'<div class="empty-state"><div class="empty-state-icon">🔄</div><div class="empty-state-title">No workflows yet</div></div>'}</div>`;
    }

    // =============================
    // Modal
    // =============================
    let openTaskId = null;
    
    function bindOpen(){ 
      $$('[data-open]').forEach(el=> {
        el.addEventListener('click', (e)=> {
          if(e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
          openTask(el.getAttribute('data-open'));
        });
      });
    }

    function openTask(id){
      openTaskId = id; 
      const t = project(id);
      const wf = workflows[t.workflow];
      const idx = wf.chain.findIndex(s=>s.role===t.current_role);
      const step = wf.chain[idx];
      
      $('#modalTitle').textContent = `${t.id} · ${t.title}`;
      
      const rulesHTML = (step.handoff_rules||[]).map(rule=>{
        const met = rule.auto_detect ? !!rule.auto_detect(t) : !!t.checkpoints[rule.id];
        const evidence = met ? (t.checkpoints[rule.id]?.evidence || 'auto-detected') : 'not met';
        return `<div class="checkpoint-item">
          <div class="checkpoint-status ${met?'met':'unmet'}">${met?'✓':'?'}</div>
          <div class="checkpoint-info">
            <div class="checkpoint-text">${rule.text}</div>
            <div class="checkpoint-evidence">${evidence}</div>
          </div>
          ${!rule.auto_detect? `<button class="btn sm" data-toggle-cp="${rule.id}">${met?'Clear':'Mark'}</button>`:''}
        </div>`;
      }).join('');

      const artHTML = t.artifacts.map(a=>`<div class="artifact-item">
        <div class="artifact-icon">${a.type==='image'?'🖼️':'📄'}</div>
        <div class="artifact-info">
          <div class="artifact-name">${a.name}</div>
          <div class="artifact-meta">Added ${ago(a.added_at)} by ${a.added_by}</div>
        </div>
      </div>`).join('') || '<div class="empty-state"><div class="empty-state-text">No artifacts yet</div></div>';

      const timeline = t.timeline.sort((a,b)=>b.ts-a.ts).map(ev=>`<div class="timeline-item ${ev.type==='role_transitioned'?'highlight':''}">
        <div class="timeline-time">${ago(ev.ts)}</div>
        <div class="timeline-content">
          <div class="timeline-actor">${ev.who}</div>
          <div class="timeline-desc">${ev.desc}</div>
        </div>
      </div>`).join('');

      $('#modalBody').innerHTML = `
        <div class="info-grid">
          <div class="info-row grid">
            <div class="section">
              <div class="section-header">Details</div>
              <div class="section-content">
                <div class="info-label">Workflow</div>
                <div class="info-value">${wf?.name||t.workflow}</div>
                <div class="info-label mt-1">Current Role</div>
                <div class="info-value">${roles[t.current_role]?.name||t.current_role}</div>
                <div class="info-label mt-1">Frame</div>
                <div class="info-value">${t.frame_id||'—'}</div>
              </div>
            </div>
            <div class="section">
              <div class="section-header">Status</div>
              <div class="section-content">
                <select id="statusSelect" class="input">
                  <option value="todo" ${t.status==='todo'?'selected':''}>To Do</option>
                  <option value="doing" ${t.status==='doing'?'selected':''}>In Progress</option>
                  <option value="done" ${t.status==='done'?'selected':''}>Completed</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="section">
            <div class="section-header">Checkpoints</div>
            <div class="checkpoint-list">${rulesHTML || '<div class="empty-state-text">No checkpoints for this step</div>'}</div>
          </div>
          
          <div class="section">
            <div class="section-header">Artifacts</div>
            <div class="info-row grid" style="margin-bottom:12px">
              <input id="artName" class="input" placeholder="filename.md or image.png"/>
              <button class="btn" id="addArtBtn">+ Add Artifact</button>
            </div>
            <div class="artifact-list">${artHTML}</div>
          </div>
          
          <div class="section">
            <div class="section-header">Activity</div>
            <div class="timeline">${timeline}</div>
          </div>
        </div>
      `;

      $('#overlay').classList.add('active');
      
      $('#statusSelect')?.addEventListener('change', (e)=>{
        const newStatus = e.target.value;
        if(newStatus !== t.status){
          recordEvent({ type:'task_status_set', task_id:openTaskId, status:newStatus, prev_status:t.status, actor:'alex', ops:[op('ALT')] });
          openTask(openTaskId); render();
        }
      });
      
      $('#addArtBtn')?.addEventListener('click', ()=>{
        const name = $('#artName').value?.trim(); if(!name) return;
        const type = /\.(png|jpg|jpeg|gif|webp|svg)$/i.test(name) ? 'image' : 'document';
        recordEvent({ type:'artifact_added', task_id:openTaskId, artifact_name:name, artifact_type:type, actor:'alex', ops:[op('INS')] });
        autoDetectCheckpoints(openTaskId);
        openTask(openTaskId); render();
      });
      
      $$('#modalBody [data-toggle-cp]').forEach(btn=> btn.addEventListener('click', ()=> toggleCheckpoint(btn.getAttribute('data-toggle-cp'))));
    }

    function closeModal(){ $('#overlay').classList.remove('active'); openTaskId=null; }
    $('#closeModal').addEventListener('click', closeModal);

    function toggleCheckpoint(id){
      if(!openTaskId) return; 
      const t = project(openTaskId);
      const met = !!t.checkpoints[id];
      if(met){ 
        recordEvent({ type:'checkpoint_cleared', task_id:openTaskId, checkpoint:id, actor:'alex', ops:[op('SEG')] }); 
      } else { 
        recordEvent({ type:'checkpoint_detected', task_id:openTaskId, checkpoint:id, evidence:'manual', source:'manual', actor:'alex', ops:[op('SEG')] }); 
      }
      openTask(openTaskId); render();
    }

    function autoDetectCheckpoints(taskId){
      const t = project(taskId); 
      const wf = workflows[t.workflow]; 
      const idx = wf.chain.findIndex(s=>s.role===t.current_role); 
      if(idx<0) return;
      const step = wf.chain[idx]; 
      (step.handoff_rules||[]).forEach(rule=>{
        if(rule.auto_detect && rule.auto_detect(t) && !t.checkpoints[rule.id]){
          recordEvent({ type:'checkpoint_detected', task_id:taskId, checkpoint:rule.id, evidence:'auto-detected', source:'auto', ops:[op('SEG')] });
        }
      });
    }

    $('#moveBtn').addEventListener('click', ()=>{
      if(!openTaskId) return; 
      const t = project(openTaskId); 
      const wf=workflows[t.workflow]; 
      const idx = wf.chain.findIndex(s=>s.role===t.current_role);
      if(idx>=wf.chain.length-1) return;
      if(!isReady(t)) { 
        alert('Task is not ready. Please meet all checkpoints or use Override & Move.'); 
        return; 
      }
      const next = wf.chain[idx+1];
      recordEvent({ type:'ready_marked', task_id:openTaskId, actor:'alex', ops:[op('ALT')] });
      recordEvent({ type:'role_transitioned', task_id:openTaskId, from_role:t.current_role, to_role:next.role, actor:'alex', ops:[op('CON')] });
      closeModal(); render();
    });

    $('#overrideBtn').addEventListener('click', ()=>{
      if(!openTaskId) return; 
      const reason = prompt('Override reason:'); 
      if(!reason) return;
      const t = project(openTaskId); 
      const wf=workflows[t.workflow]; 
      const idx = wf.chain.findIndex(s=>s.role===t.current_role); 
      if(idx>=wf.chain.length-1) return;
      const next = wf.chain[idx+1];
      recordEvent({ type:'override_move', task_id:openTaskId, from_role:t.current_role, to_role:next.role, reason, actor:'alex', ops:[op('SUP'),op('REC')] });
      recordEvent({ type:'role_transitioned', task_id:openTaskId, from_role:t.current_role, to_role:next.role, actor:'alex', ops:[op('CON')] });
      closeModal(); render();
    });

    // =============================
    // Interactions
    // =============================
    function attachNavListeners(){
      $$('.nav-item').forEach(n=>{
        n.onclick = ()=>{
          $$('.nav-item').forEach(x=>x.classList.remove('active'));
          n.classList.add('active');
          currentView = {
            type: n.dataset.view,
            id: n.dataset.role || n.dataset.workflow || n.dataset.person || null
          };
          layout = getLayoutForView(currentView.type);
          render();
        };
      });
    }

    $$('.view-toggle .btn').forEach(b=> b.addEventListener('click', ()=>{
      if(b.disabled) return;
      const nextLayout = b.dataset.layout;
      if(layout === nextLayout) return;
      layout = nextLayout;
      saveLayoutPreference(currentView.type, layout);
      updateViewToggle();
      render();
    }));

    function updateViewToggle(){
      const supportsList = viewSupportsList(currentView.type);
      if(!supportsList && layout === 'list'){
        layout = 'board';
      }
      $$('.view-toggle .btn').forEach(btn=>{
        const layoutType = btn.dataset.layout;
        const disable = layoutType === 'list' && !supportsList;
        btn.disabled = disable;
        btn.style.opacity = disable ? 0.5 : '';
        btn.style.cursor = disable ? 'not-allowed' : '';
        const isActive = !disable && layoutType === layout;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    $('#newTask').addEventListener('click', ()=>{
      const title = prompt('Task title:'); 
      if(!title) return;
      const wfs = Object.values(workflows); 
      const choice = prompt('Select workflow:\n' + wfs.map((w,i)=>`${i+1}. ${w.name}`).join('\n')); 
      if(!choice) return;
      const wf = wfs[parseInt(choice)-1]; 
      if(!wf) return alert('Invalid selection');
      const id = nextTaskId();
      recordEvent({ type:'task_created', task_id:id, title, workflow:wf.id, initial_role:wf.chain[0].role, actor:'alex', ops:[op('DES'),op('INS')] });
      recordEvent({ type:'task_status_set', task_id:id, status:'todo', prev_status:null, actor:'alex', ops:[op('ALT')] });
      render();
    });

    $('#newCheckpoint').addEventListener('click', ()=>{
      if(currentView.type!=='workflow') {
        alert('Please open a Workflow view to add checkpoints.');
        return;
      }
      const wf = workflows[currentView.id]; 
      if(!wf) return;
      const roleIdx = prompt('Add checkpoint after which role?\n' + wf.chain.map((s,i)=>`${i+1}. ${roles[s.role]?.name||s.role}`).join('\n')); 
      if(!roleIdx) return;
      const idx = parseInt(roleIdx)-1; 
      const s = wf.chain[idx]; 
      if(!s) return alert('Invalid selection');
      const text = prompt('Checkpoint text:'); 
      if(!text) return;
      s.handoff_rules = s.handoff_rules||[]; 
      s.handoff_rules.push({ id: text.toLowerCase().replace(/\s+/g,'-'), text, auto_detect:null });
      recordEvent({ type:'workflow_checkpoint_added', workflow_id:wf.id, role:s.role, text, actor:'alex', ops:[op('SEG')] });
      render();
    });

    function nextTaskId(){
      const n = taskIds().reduce((m,id)=> Math.max(m, parseInt(id.split('-')[1],10)||0), 0) + 1;
      return 'TASK-' + String(n).padStart(3,'0');
    }

    function enableStatusDragDrop(){
      $$('.column-body[data-drop-status]').forEach(col=>{
        col.addEventListener('dragover', e=>{ e.preventDefault(); });
        col.addEventListener('drop', e=>{
          const taskId = e.dataTransfer.getData('text/plain'); 
          if(!taskId) return;
          const t = project(taskId); 
          const targetStatus = col.getAttribute('data-drop-status');
          if(t.status === targetStatus) return;
          recordEvent({ type:'task_status_set', task_id:taskId, status:targetStatus, prev_status:t.status, actor:'alex', ops:[op('ALT')] });
          render();
        });
      });
      $$('.card[draggable]').forEach(c=>{
        c.addEventListener('dragstart', e=>{ 
          e.dataTransfer.setData('text/plain', c.getAttribute('data-open')); 
        });
      });
    }

    function enableDragDrop(){
      $$('.column-body[data-drop]').forEach(col=>{
        col.addEventListener('dragover', e=>{ e.preventDefault(); });
        col.addEventListener('drop', e=>{
          const taskId = e.dataTransfer.getData('text/plain'); 
          if(!taskId) return;
          const t = project(taskId); 
          const targetRole = col.getAttribute('data-drop');
          if(t.current_role===targetRole) return;
          const wf=workflows[t.workflow]; 
          const idx = wf.chain.findIndex(s=>s.role===t.current_role); 
          const next = wf.chain[idx+1]?.role;
          if(next!==targetRole) {
            alert('Can only move to next step in workflow');
            return;
          }
          if(!isReady(t)){
            const ok = confirm('Task is not ready. Override move?');
            if(!ok) return; 
            const reason = prompt('Override reason:') || 'drag override';
            recordEvent({ type:'override_move', task_id:taskId, from_role:t.current_role, to_role:next, reason, actor:'alex', ops:[op('SUP'),op('REC')] });
          } else { 
            recordEvent({ type:'ready_marked', task_id:taskId, actor:'alex', ops:[op('ALT')] }); 
          }
          recordEvent({ type:'role_transitioned', task_id:taskId, from_role:t.current_role, to_role:next, actor:'alex', ops:[op('CON')] });
          render();
        });
      });
      $$('.card[draggable]').forEach(c=>{
        c.addEventListener('dragstart', e=>{ 
          e.dataTransfer.setData('text/plain', c.getAttribute('data-open')); 
        });
      });
    }

    // Theme
    (function initTheme(){ 
      const saved = localStorage.getItem('theme')||'dark'; 
      document.documentElement.setAttribute('data-theme', saved); 
      $('#themeToggle').textContent = saved==='dark'?'🌙':'☀️'; 
    })();
    
    $('#themeToggle').addEventListener('click', ()=>{ 
      const cur=document.documentElement.getAttribute('data-theme'); 
      const nxt=cur==='dark'?'light':'dark'; 
      document.documentElement.setAttribute('data-theme',nxt); 
      localStorage.setItem('theme',nxt); 
      $('#themeToggle').textContent = nxt==='dark'?'🌙':'☀️'; 
    });

    function ago(ts){ 
      const d=Date.now()-ts; 
      if(d<6e4) return 'just now'; 
      if(d<36e5) return Math.floor(d/6e4)+'m'; 
      if(d<864e5) return Math.floor(d/36e5)+'h'; 
      return new Date(ts).toLocaleDateString(); 
    }

    // Init
    attachNavListeners();
    $$('.nav-item')[0]?.classList.add('active');
    render();
  </script>
</body>
</html>
