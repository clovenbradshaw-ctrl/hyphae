<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EO - Emergent Organizing</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const OPERATORS = [
      { id: 'starter', name: 'Starter', desc: 'Designs & initiates work', seq: 1, canRequestRevision: false },
      { id: 'doer', name: 'Doer', desc: 'Produces artifacts & outputs', seq: 2, canRequestRevision: false },
      { id: 'compiler', name: 'Compiler', desc: 'Packages work into reviewable form', seq: 3, canRequestRevision: false },
      { id: 'reviewer', name: 'Reviewer', desc: 'Evaluates & segments quality', seq: 4, canRequestRevision: true },
      { id: 'approver', name: 'Approver', desc: 'Alters state with authority', seq: 5, canRequestRevision: true },
      { id: 'documenter', name: 'Documenter', desc: 'Records & formalizes', seq: 6, canRequestRevision: false },
      { id: 'convener', name: 'Convener', desc: 'Assembles people & resources', seq: 7, canRequestRevision: false },
      { id: 'steward', name: 'Steward', desc: 'Supervises ongoing work', seq: 8, canRequestRevision: false },
      { id: 'coordinator', name: 'Coordinator', desc: 'Orchestrates next cycle', seq: 9, canRequestRevision: false }
    ];

    const DEFAULT_STAGE_TEMPLATE = [
      { id: 'start', name: 'Start readiness', scope: 'destination', description: 'Work on the destination cannot begin until this is met.' },
      { id: 'handoff', name: 'In-flight handoff', scope: 'both', description: 'A mid-stream signal or delivery between activities.' },
      { id: 'complete', name: 'Complete', scope: 'source', description: 'The source must be completed before the dependency is satisfied.' }
    ];

    const DEFAULT_SOURCE_STAGE = 'complete';
    const DEFAULT_DESTINATION_STAGE = 'start';

    function cloneDefaultStages() {
      return DEFAULT_STAGE_TEMPLATE.map(stage => ({ ...stage }));
    }

    function deriveStageScope(stage) {
      if (!stage) return 'both';
      if (stage.scope) return stage.scope;

      const applies = stage.appliesTo;
      let allowSource;
      let allowDestination;

      if (Array.isArray(applies)) {
        allowSource = applies.includes('source');
        allowDestination = applies.includes('destination');
      } else if (applies && typeof applies === 'object') {
        allowSource = applies.source ?? applies.from ?? false;
        allowDestination = applies.destination ?? applies.to ?? false;
      }

      if (typeof stage.allowSource === 'boolean') allowSource = stage.allowSource;
      if (typeof stage.allowDestination === 'boolean') allowDestination = stage.allowDestination;
      if (typeof stage.source === 'boolean') allowSource = stage.source;
      if (typeof stage.destination === 'boolean') allowDestination = stage.destination;

      if (allowSource && allowDestination) return 'both';
      if (allowSource) return 'source';
      if (allowDestination) return 'destination';
      return 'both';
    }

    function ensureStageList(stages) {
      const base = Array.isArray(stages) && stages.length > 0 ? stages : cloneDefaultStages();
      const normalized = base.map(stage => {
        const id = stage.id || stage.value || stage.key;
        const name = stage.name || stage.label || stage.title || id;
        const scope = deriveStageScope(stage);
        return { ...stage, id, name, scope };
      });

      const hasSource = normalized.some(stage => stage.scope === 'source' || stage.scope === 'both');
      const hasDestination = normalized.some(stage => stage.scope === 'destination' || stage.scope === 'both');
      const enriched = [...normalized];

      if (!hasSource) {
        const template = DEFAULT_STAGE_TEMPLATE.find(stage => stage.id === DEFAULT_SOURCE_STAGE);
        if (template) enriched.push({ ...template });
      }

      if (!hasDestination) {
        const template = DEFAULT_STAGE_TEMPLATE.find(stage => stage.id === DEFAULT_DESTINATION_STAGE);
        if (template) enriched.push({ ...template });
      }

      return enriched;
    }

    function ensureFlowStages(flow) {
      return ensureStageList(flow?.stages);
    }

    function normalizeEdgeStages(edge) {
      if (!edge) return edge;
      const srcStage = edge.srcStage || DEFAULT_SOURCE_STAGE;
      const dstStage = edge.dstStage || DEFAULT_DESTINATION_STAGE;
      return { ...edge, srcStage, dstStage, __legacyStage: !edge.srcStage || !edge.dstStage };
    }

    function stageScopeLabel(scope) {
      if (scope === 'source') return 'Source only';
      if (scope === 'destination') return 'Destination only';
      return 'Source & destination';
    }

    function stageNameForDisplay(stage) {
      return stage?.name || stage?.label || stage?.id || '';
    }

    function isStageSatisfied(activity, stageId) {
      if (!activity) return false;
      switch (stageId) {
        case 'start':
          return Boolean(activity.claimedBy || activity.completedAt);
        case 'handoff':
          return Boolean(activity.completedAt);
        case 'complete':
        default:
          return Boolean(activity.completedAt);
      }
    }

    // Icons
    function PlusIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>;
    }
    function ArrowLeftIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>;
    }
    function LayersIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>;
    }
    function ChevronRightIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>;
    }
    function XIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
    }
    function LinkIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>;
    }
    function ChatBubbleIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 1.657-1.79 3-4 3-.295 0-.582-.021-.859-.061-.284 1.193-1.355 2.06-2.641 2.06-.358 0-.703-.065-1.019-.184-.44.498-1.086.814-1.781.814-.732 0-1.392-.347-1.829-.888-.51.355-1.137.558-1.812.558-1.648 0-2.985-1.343-2.985-3 0-.333.054-.654.153-.954C3.1 12.715 2 11.477 2 10c0-1.657 1.79-3 4-3h11c2.21 0 4 1.343 4 3z" /></svg>;
    }

    function ActivityDetailPanel({ activity, role, operator, dependencies, project, currentUser, onClose, onEdit, onDelete, onClaim, onUnclaim, onComplete, onWire, onRequestRevision, onAddComment, onAddAttachment, onRemoveAttachment }) {
      const [commentText, setCommentText] = useState('');
      const [attachmentName, setAttachmentName] = useState('');
      const [attachmentUrl, setAttachmentUrl] = useState('');

      useEffect(() => {
        setCommentText('');
        setAttachmentName('');
        setAttachmentUrl('');
      }, [activity?.id]);

      const isMine = activity.claimedBy === currentUser;
      const canClaim = activity.state === 'ready' && !activity.claimedBy && role?.userIds.some(uid => project.users.find(u => u.id === uid)?.name === currentUser);
      const canComplete = isMine && activity.state === 'in_progress';

      const comments = [...(activity.comments || [])].sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
      const history = [...(activity.history || [])].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

      const handleAddComment = () => {
        if (!currentUser || !commentText.trim()) return;
        onAddComment(commentText);
        setCommentText('');
      };

      const handleAddAttachment = () => {
        if (!attachmentName.trim() || !currentUser) return;
        onAddAttachment({ name: attachmentName.trim(), url: attachmentUrl.trim(), addedBy: currentUser });
        setAttachmentName('');
        setAttachmentUrl('');
      };

      const renderCommentContent = (text) => {
        const parts = text.split(/(@[\w-]+)/g);
        return parts.map((part, idx) => {
          if (part.startsWith && part.startsWith('@')) {
            const name = part.slice(1);
            const isMe = currentUser && name.toLowerCase() === currentUser.toLowerCase();
            return <span key={idx} className={isMe ? 'text-blue-300 font-semibold' : 'text-blue-400'}>{part}</span>;
          }
          return <span key={idx}>{part}</span>;
        });
      };

      const dependencyGroups = useMemo(() => {
        const grouped = {};
        dependencies.forEach(dep => {
          const key = dep.dstStage || 'unspecified';
          if (!grouped[key]) {
            grouped[key] = {
              stageLabel: dep.dstStageLabel || dep.dstStage || 'Unspecified stage',
              stageDescription: dep.dstStageDescription,
              items: []
            };
          }
          grouped[key].items.push(dep);
        });
        return Object.values(grouped);
      }, [dependencies]);

      const hasLegacyStageDeps = useMemo(() => dependencies.some(dep => dep.isLegacyStage), [dependencies]);

      const actionButtons = (
        <div className="flex flex-wrap gap-2">
          {canClaim && <button onClick={() => onClaim(activity.id)} className="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm">Claim</button>}
          {isMine && !activity.completedAt && <button onClick={() => onUnclaim(activity.id)} className="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">Unclaim</button>}
          {canComplete && <button onClick={() => onComplete(activity.id)} className="bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded text-sm">Complete</button>}
          {canComplete && operator?.canRequestRevision && dependencies.length > 0 && (
            <button onClick={() => { const lastDep = dependencies[dependencies.length - 1]; if (lastDep) onRequestRevision(activity.id, lastDep.activity.id); }} className="bg-orange-600 hover:bg-orange-700 px-3 py-1.5 rounded text-sm">Request revision</button>
          )}
          {!activity.completedAt && <button onClick={() => onWire(activity.id)} className="bg-purple-600 hover:bg-purple-700 px-3 py-1.5 rounded text-sm">Wire</button>}
          {!activity.completedAt && <button onClick={() => onEdit(activity.id)} className="bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded text-sm">Edit</button>}
          {!activity.completedAt && <button onClick={() => onDelete(activity.id)} className="bg-red-700 hover:bg-red-800 px-3 py-1.5 rounded text-sm">Delete</button>}
        </div>
      );

      return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex justify-end z-40" aria-modal="true" role="dialog">
          <div className="w-full max-w-md bg-gray-900 border-l border-gray-800 h-full overflow-y-auto">
            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-800">
              <div>
                <h2 className="text-lg font-semibold text-gray-100">{activity.title}</h2>
                <div className="text-xs text-gray-400 mt-1">State: {activity.state.replace('_', ' ')}</div>
              </div>
              <button onClick={onClose} className="p-2 rounded hover:bg-gray-800"><XIcon className="w-4 h-4" /></button>
            </div>

            <div className="px-6 py-4 space-y-6">
              <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-3">
                <div className="flex items-start justify-between">
                  <div className="space-y-2 text-sm text-gray-200">
                    {role && <div><span className="text-gray-400">Role:</span> {role.name}</div>}
                    {operator && <div><span className="text-gray-400">Operator:</span> {operator.name}</div>}
                    {activity.deliverable && <div><span className="text-gray-400">Deliverable:</span> {activity.deliverable}</div>}
                    {activity.claimedBy && <div><span className="text-gray-400">Claimed by:</span> {activity.claimedBy} {activity.priority && <span className="text-xs bg-blue-900/60 text-blue-200 px-2 py-0.5 ml-2 rounded">{activity.priority}</span>}</div>}
                    <div className="text-xs text-gray-500">Created {formatTimestamp(activity.createdAt)}</div>
                  </div>
                </div>
                {dependencies.length > 0 && (
                  <div className="text-sm text-gray-200 space-y-3">
                    <div className="text-gray-400">Dependencies by stage</div>
                    {dependencyGroups.map((group, idx) => (
                      <div key={idx} className="bg-gray-900/40 border border-gray-800 rounded p-3">
                        <div className="flex items-center justify-between text-xs text-gray-300 mb-2">
                          <span className="font-semibold text-gray-100">{group.stageLabel}</span>
                          {group.stageDescription && <span className="text-gray-500">{group.stageDescription}</span>}
                        </div>
                        <ul className="space-y-1">
                          {group.items.map((dep, itemIdx) => (
                            <li key={itemIdx} className="flex items-center gap-2 text-xs">
                              <ChevronRightIcon className="w-3 h-3 text-gray-500" />
                              <span className={`${dep.isSatisfied ? 'line-through text-gray-500' : ''}`}>{dep.activity.title}</span>
                              <span className="text-gray-500">({dep.srcStageLabel})</span>
                              {dep.edgeType === 'loops' && <span className="text-orange-400">(revision)</span>}
                              {dep.isLegacyStage && <span className="text-[10px] uppercase tracking-wide text-yellow-300 bg-yellow-900/40 px-1.5 py-0.5 rounded">Legacy</span>}
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                )}
                {hasLegacyStageDeps && (
                  <div className="text-xs text-yellow-200 bg-yellow-900/30 border border-yellow-800/40 rounded p-3">
                    Some dependencies were created before stage tracking. Rewire them to assign source and destination stages.
                  </div>
                )}
                {actionButtons}
              </div>

              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-sm font-semibold text-gray-100">Attachments</h3>
                </div>
                <div className="space-y-2">
                  {(activity.attachments || []).length === 0 ? (
                    <div className="text-xs text-gray-500">No attachments yet.</div>
                  ) : (
                    (activity.attachments || []).map(att => (
                      <div key={att.id} className="flex items-center justify-between bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-gray-200">
                        <div className="flex flex-col">
                          <span>{att.name}</span>
                          {att.url && <a href={att.url} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-400 hover:text-blue-300">{att.url}</a>}
                          <span className="text-xs text-gray-500">Added {att.addedBy || 'someone'} · {formatRelativeTime(att.addedAt)}</span>
                        </div>
                        <button onClick={() => onRemoveAttachment(att.id)} className="text-xs text-gray-400 hover:text-gray-200">Remove</button>
                      </div>
                    ))
                  )}
                  <div className="bg-gray-800 border border-gray-700 rounded-lg p-3 space-y-2">
                    <input type="text" value={attachmentName} onChange={(e) => setAttachmentName(e.target.value)} placeholder="File name" className="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm" />
                    <input type="text" value={attachmentUrl} onChange={(e) => setAttachmentUrl(e.target.value)} placeholder="Link (optional)" className="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm" />
                    <button onClick={handleAddAttachment} disabled={!currentUser || !attachmentName.trim()} className="w-full bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:text-gray-500 text-sm py-2 rounded">Add attachment</button>
                  </div>
                </div>
              </div>

              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-sm font-semibold text-gray-100">Comments ({comments.length})</h3>
                </div>
                <div className="space-y-3">
                  {comments.length === 0 ? (
                    <div className="text-xs text-gray-500">No comments yet.</div>
                  ) : (
                    comments.map(comment => (
                      <div key={comment.id} className="bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm text-gray-100">
                        <div className="flex items-center justify-between text-xs text-gray-400 mb-2">
                          <span>{comment.author}{comment.system && ' · system'}</span>
                          <span>{formatRelativeTime(comment.createdAt)}</span>
                        </div>
                        <div className="leading-relaxed">{renderCommentContent(comment.content)}</div>
                      </div>
                    ))
                  )}
                  <div className="bg-gray-800 border border-gray-700 rounded-lg p-3 space-y-2">
                    <textarea value={commentText} onChange={(e) => setCommentText(e.target.value)} placeholder={currentUser ? 'Add a comment with @mentions' : 'Set your name in the dashboard to comment'} className="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm" rows={3} disabled={!currentUser} />
                    <div className="flex justify-end">
                      <button onClick={handleAddComment} disabled={!currentUser || !commentText.trim()} className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:text-gray-400 px-3 py-1.5 rounded text-sm">Comment</button>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <h3 className="text-sm font-semibold text-gray-100 mb-3">History</h3>
                <div className="space-y-2 text-sm text-gray-200">
                  {history.length === 0 ? (
                    <div className="text-xs text-gray-500">No history yet.</div>
                  ) : (
                    history.map(entry => (
                      <div key={entry.id} className="flex items-start gap-2">
                        <div className="text-xs text-gray-500 w-28 flex-shrink-0">{formatRelativeTime(entry.timestamp)}</div>
                        <div className="flex-1">{entry.text}</div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    function formatRelativeTime(timestamp) {
      if (!timestamp) return '';
      const diff = Date.now() - timestamp;
      const minutes = Math.floor(diff / 60000);
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function extractMentions(content) {
      const regex = /@([\w-]+)/g;
      const mentions = new Set();
      let match;
      while ((match = regex.exec(content))) {
        mentions.add(match[1]);
      }
      return Array.from(mentions);
    }
    function RefreshIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>;
    }
    function EditIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
    }
    function TrashIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
    }
    function UsersIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>;
    }
    function HomeIcon(props) {
      return <svg {...props} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>;
    }

    function computeActivityState(activity, allActivities, edges, stageId = DEFAULT_DESTINATION_STAGE) {
      if (activity.completedAt) return 'completed';
      if (activity.claimedBy) return 'in_progress';

      const inbound = edges
        .map(normalizeEdgeStages)
        .filter(e => e.dstId === activity.id && e.dstStage === stageId);
      if (inbound.length === 0) return 'ready';

      const allComplete = inbound.every(edge => {
        const src = allActivities.find(a => a.id === edge.srcId);
        return isStageSatisfied(src, edge.srcStage);
      });

      return allComplete ? 'ready' : 'waiting';
    }

    function EventOperator() {
      const [view, setView] = useState('welcome');
      const [currentUser, setCurrentUser] = useState('');
      const [projects, setProjects] = useState([]);
      const [selectedProject, setSelectedProject] = useState(null);
      const [selectedFlow, setSelectedFlow] = useState(null);
      const [roles, setRoles] = useState([]);
      const [showModal, setShowModal] = useState(null);
      const [modalData, setModalData] = useState({});

      useEffect(() => {
        if (selectedProject && projects.length > 0) {
          const updated = projects.find(p => p.id === selectedProject.id);
          if (updated) setSelectedProject(updated);
        }
      }, [projects]);

      useEffect(() => {
        if (selectedFlow && selectedProject) {
          const updated = selectedProject.flows.find(f => f.id === selectedFlow.id);
          if (updated) setSelectedFlow(updated);
        }
      }, [selectedProject]);

      const createProject = (name, users, currentUserName) => {
        const project = { 
          id: `p-${Date.now()}`, 
          name, 
          users: users.map(u => ({ id: `u-${Date.now()}-${Math.random()}`, name: u })),
          flows: [] 
        };
        setProjects([...projects, project]);
        setCurrentUser(currentUserName);
        setView('dashboard');
      };

      const addUserToProject = (projectId, userName) => {
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          users: [...p.users, { id: `u-${Date.now()}`, name: userName }]
        } : p));
      };

      const removeUserFromProject = (projectId, userId) => {
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          users: p.users.filter(u => u.id !== userId)
        } : p));
      };

      const createFlow = (projectId, name, deliverables, description) => {
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
            flows: [...p.flows, {
            id: `f-${Date.now()}`,
            name,
            deliverables,
            description,
            activities: [],
            edges: [],
            stages: cloneDefaultStages()
          }]
        } : p));
      };

      const createActivity = (projectId, flowId, title, roleId, deliverable = '') => {
        const timestamp = Date.now();
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: [...f.activities, {
              id: `a-${Date.now()}`,
              title,
              roleId,
              deliverable,
              claimedBy: null,
              priority: null,
              createdAt: timestamp,
              comments: [],
              attachments: [],
              history: [{ id: `h-${timestamp}`, text: `${currentUser || 'Someone'} created this activity`, timestamp }],
              readBy: {}
            }]
          } : f)
        } : p));
      };

      const updateActivity = (projectId, flowId, activityId, updates) => {
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? { ...a, ...updates } : a)
          } : f)
        } : p));
      };

      const deleteActivity = (projectId, flowId, activityId) => {
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.filter(a => a.id !== activityId),
            edges: f.edges.filter(e => e.srcId !== activityId && e.dstId !== activityId)
          } : f)
        } : p));
      };

      const createEdge = (projectId, flowId, srcId, dstId, type, srcStage = DEFAULT_SOURCE_STAGE, dstStage = DEFAULT_DESTINATION_STAGE) => {
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            edges: [...f.edges, {
              id: `e-${Date.now()}`,
              type,
              srcId,
              dstId,
              srcStage,
              dstStage
            }]
          } : f)
        } : p));
      };

      const createRole = (name, operatorType, userIds = []) => {
        const role = {
          id: `r-${Date.now()}`,
          name,
          operatorType,
          userIds
        };
        setRoles([...roles, role]);
        return role;
      };

      const updateRole = (roleId, updates) => {
        setRoles(prev => prev.map(r => r.id === roleId ? { ...r, ...updates } : r));
      };

      const claimActivity = (projectId, flowId, activityId, priority) => {
        const timestamp = Date.now();
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? {
              ...a,
              claimedBy: currentUser,
              priority,
              comments: [...(a.comments || []), {
                id: `c-${timestamp}`,
                author: currentUser,
                content: `${currentUser} claimed this`,
                createdAt: timestamp,
                mentions: [],
                system: true
              }],
              history: [...(a.history || []), { id: `h-${timestamp}`, text: `${currentUser} claimed (priority: ${priority})`, timestamp }],
              readBy: { ...(a.readBy || {}), [currentUser]: timestamp }
            } : a)
          } : f)
        } : p));
      };

      const unclaimActivity = (projectId, flowId, activityId) => {
        const timestamp = Date.now();
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? {
              ...a,
              claimedBy: null,
              priority: null,
              comments: [...(a.comments || []), {
                id: `c-${timestamp}`,
                author: currentUser,
                content: `${currentUser} unclaimed this`,
                createdAt: timestamp,
                mentions: [],
                system: true
              }],
              history: [...(a.history || []), { id: `h-${timestamp}`, text: `${currentUser} unclaimed`, timestamp }],
              readBy: { ...(a.readBy || {}), [currentUser]: timestamp }
            } : a)
          } : f)
        } : p));
      };

      const completeActivity = (projectId, flowId, activityId) => {
        const timestamp = Date.now();
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? {
              ...a,
              completedAt: timestamp,
              comments: [...(a.comments || []), {
                id: `c-${timestamp}`,
                author: currentUser,
                content: `${currentUser} completed this`,
                createdAt: timestamp,
                mentions: [],
                system: true
              }],
              history: [...(a.history || []), { id: `h-${timestamp}`, text: `${currentUser} marked complete`, timestamp }],
              readBy: { ...(a.readBy || {}), [currentUser]: timestamp }
            } : a)
          } : f)
        } : p));
      };

      const addCommentToActivity = (projectId, flowId, activityId, author, content) => {
        const trimmed = content.trim();
        if (!trimmed) return;
        const timestamp = Date.now();
        const mentions = extractMentions(trimmed);
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? {
              ...a,
              comments: [...(a.comments || []), { id: `c-${timestamp}`, author, content: trimmed, createdAt: timestamp, mentions, system: false }],
              history: [...(a.history || []), { id: `h-${timestamp}`, text: `${author} commented`, timestamp }],
              readBy: { ...(a.readBy || {}), [author]: timestamp }
            } : a)
          } : f)
        } : p));
      };

      const addAttachmentToActivity = (projectId, flowId, activityId, attachment) => {
        const timestamp = Date.now();
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? {
              ...a,
              attachments: [...(a.attachments || []), { ...attachment, id: attachment.id || `att-${timestamp}`, addedAt: timestamp }],
              history: [...(a.history || []), { id: `h-${timestamp}`, text: `${attachment.addedBy} attached ${attachment.name}`, timestamp }]
            } : a)
          } : f)
        } : p));
      };

      const removeAttachmentFromActivity = (projectId, flowId, activityId, attachmentId) => {
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? {
              ...a,
              attachments: (a.attachments || []).filter(att => att.id !== attachmentId)
            } : a)
          } : f)
        } : p));
      };

      const markActivityRead = (projectId, flowId, activityId, userName) => {
        const timestamp = Date.now();
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: f.activities.map(a => a.id === activityId ? {
              ...a,
              readBy: { ...(a.readBy || {}), [userName]: timestamp }
            } : a)
          } : f)
        } : p));
      };

      const spawnActivity = (projectId, flowId, sourceActivityId, title, roleId, deliverable = '') => {
        const newActivityId = `a-${Date.now()}`;
        const timestamp = Date.now();
        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: [...f.activities, {
              id: newActivityId,
              title,
              roleId,
              deliverable,
              claimedBy: null,
              priority: null,
              createdAt: timestamp,
              comments: [],
              attachments: [],
              history: [{ id: `h-${timestamp}`, text: `${currentUser || 'Someone'} spawned this from another activity`, timestamp }],
              readBy: {}
            }],
            edges: [...f.edges, {
              id: `e-${Date.now()}`,
              type: 'enables',
              srcId: sourceActivityId,
              dstId: newActivityId,
              srcStage: DEFAULT_SOURCE_STAGE,
              dstStage: DEFAULT_DESTINATION_STAGE
            }]
          } : f)
        } : p));
      };

      const requestRevision = (projectId, flowId, reviewerId, targetActivityId) => {
        const flow = projects.find(p => p.id === projectId)?.flows.find(f => f.id === flowId);
        const targetActivity = flow?.activities.find(a => a.id === targetActivityId);
        if (!targetActivity) return;

        const revisionId = `a-${Date.now()}`;
        const timestamp = Date.now();

        setProjects(prev => prev.map(p => p.id === projectId ? {
          ...p,
          flows: p.flows.map(f => f.id === flowId ? {
            ...f,
            activities: [...f.activities, {
              id: revisionId,
              title: `${targetActivity.title} (revision)`,
              roleId: targetActivity.roleId,
              deliverable: targetActivity.deliverable,
              claimedBy: null,
              priority: null,
              isRevision: true,
              createdAt: timestamp,
              comments: [],
              attachments: [],
              history: [{ id: `h-${timestamp}`, text: `${currentUser || 'Someone'} requested a revision`, timestamp }],
              readBy: {}
            }],
            edges: [
              ...f.edges,
              { id: `e-${Date.now()}-1`, type: 'loops', srcId: reviewerId, dstId: revisionId, srcStage: DEFAULT_SOURCE_STAGE, dstStage: DEFAULT_DESTINATION_STAGE },
              { id: `e-${Date.now()}-2`, type: 'enables', srcId: revisionId, dstId: reviewerId, srcStage: DEFAULT_SOURCE_STAGE, dstStage: DEFAULT_DESTINATION_STAGE }
            ]
          } : f)
        } : p));
      };

      let mainContent;

      if (view === 'welcome') {
        mainContent = <WelcomeView onCreate={createProject} />;
      } else if (view === 'dashboard') {
        mainContent = <DashboardView projects={projects} currentUser={currentUser} roles={roles} onSelectFlow={(p, f) => { setSelectedProject(p); setSelectedFlow(f); setView('activities'); }} onCreateProject={() => setShowModal('createProject')} onManageUsers={(p) => { setSelectedProject(p); setShowModal('manageUsers'); }} onCreateFlow={(p) => { setSelectedProject(p); setShowModal('createFlow'); }} />;
      } else if (view === 'activities' && selectedProject && selectedFlow) {
        mainContent = (
          <ActivitiesView
            project={selectedProject}
            flow={selectedFlow}
            roles={roles}
            currentUser={currentUser}
            onBack={() => { setSelectedFlow(null); setSelectedProject(null); setView('dashboard'); }}
            onCreateActivity={(operatorId) => {
              setModalData(operatorId ? { operatorId } : {});
              setShowModal('createActivity');
            }}
            onEditActivity={(aid) => { setModalData({ projectId: selectedProject.id, flowId: selectedFlow.id, activityId: aid }); setShowModal('editActivity'); }}
            onDeleteActivity={(aid) => { setModalData({ projectId: selectedProject.id, flowId: selectedFlow.id, activityId: aid }); setShowModal('deleteActivity'); }}
            onClaimActivity={(aid) => { setModalData({ projectId: selectedProject.id, flowId: selectedFlow.id, activityId: aid }); setShowModal('claimActivity'); }}
            onUnclaimActivity={(aid) => unclaimActivity(selectedProject.id, selectedFlow.id, aid)}
            onCompleteActivity={(aid) => { setModalData({ projectId: selectedProject.id, flowId: selectedFlow.id, activityId: aid }); setShowModal('completeActivity'); }}
            onWireActivity={(aid) => { setModalData({ projectId: selectedProject.id, flowId: selectedFlow.id, activityId: aid }); setShowModal('wireActivity'); }}
            onRequestRevision={(reviewerId, targetId) => requestRevision(selectedProject.id, selectedFlow.id, reviewerId, targetId)}
            onAddComment={addCommentToActivity}
            onAddAttachment={addAttachmentToActivity}
            onRemoveAttachment={removeAttachmentFromActivity}
            onMarkRead={markActivityRead}
          />
        );
      }

      return (
        <>
          {mainContent}
          {showModal === 'createProject' && <CreateProjectModal onClose={() => setShowModal(null)} onCreate={(name, users) => { createProject(name, users, currentUser); setShowModal(null); }} />}
          {showModal === 'createFlow' && selectedProject && <CreateFlowModal onClose={() => setShowModal(null)} onCreate={(name, del, desc) => { createFlow(selectedProject.id, name, del, desc); setShowModal(null); }} />}
          {showModal === 'manageUsers' && selectedProject && <ManageUsersModal project={selectedProject} onClose={() => setShowModal(null)} onAddUser={(name) => addUserToProject(selectedProject.id, name)} onRemoveUser={(uid) => removeUserFromProject(selectedProject.id, uid)} />}
          {showModal === 'createActivity' && selectedProject && selectedFlow && <CreateActivityModal project={selectedProject} flow={selectedFlow} roles={roles} initialOperatorId={modalData.operatorId} onClose={() => { setShowModal(null); setModalData({}); }} onCreate={(title, roleId, deliverable) => { createActivity(selectedProject.id, selectedFlow.id, title, roleId, deliverable); setShowModal(null); setModalData({}); }} onCreateRole={createRole} onUpdateRole={updateRole} />}
          {showModal === 'editActivity' && selectedFlow && <EditActivityModal project={selectedProject} activity={selectedFlow.activities.find(a => a.id === modalData.activityId)} roles={roles} onClose={() => { setShowModal(null); setModalData({}); }} onUpdate={(updates) => { updateActivity(modalData.projectId, modalData.flowId, modalData.activityId, updates); setShowModal(null); setModalData({}); }} onCreateRole={createRole} onUpdateRole={updateRole} />}
          {showModal === 'deleteActivity' && selectedFlow && <DeleteActivityModal activity={selectedFlow.activities.find(a => a.id === modalData.activityId)} onClose={() => { setShowModal(null); setModalData({}); }} onDelete={() => { deleteActivity(modalData.projectId, modalData.flowId, modalData.activityId); setShowModal(null); setModalData({}); }} />}
          {showModal === 'claimActivity' && selectedFlow && <ClaimActivityModal activity={selectedFlow.activities.find(a => a.id === modalData.activityId)} roles={roles} project={selectedProject} onClose={() => { setShowModal(null); setModalData({}); }} onClaim={(priority) => { claimActivity(modalData.projectId, modalData.flowId, modalData.activityId, priority); setShowModal(null); setModalData({}); }} />}
          {showModal === 'completeActivity' && selectedFlow && <CompleteActivityModal project={selectedProject} activity={selectedFlow.activities.find(a => a.id === modalData.activityId)} flow={selectedFlow} roles={roles} onClose={() => { setShowModal(null); setModalData({}); }} onComplete={(spawnNext) => { completeActivity(modalData.projectId, modalData.flowId, modalData.activityId); if (spawnNext) { spawnActivity(modalData.projectId, modalData.flowId, modalData.activityId, spawnNext.title, spawnNext.roleId, spawnNext.deliverable); } setShowModal(null); setModalData({}); }} onCreateRole={createRole} onUpdateRole={updateRole} />}
          {showModal === 'wireActivity' && selectedFlow && <WireActivityModal project={selectedProject} activity={selectedFlow.activities.find(a => a.id === modalData.activityId)} flow={selectedFlow} roles={roles} onClose={() => { setShowModal(null); setModalData({}); }} onWire={(targetId, edgeType, srcStage, dstStage) => { createEdge(modalData.projectId, modalData.flowId, modalData.activityId, targetId, edgeType, srcStage, dstStage); setShowModal(null); setModalData({}); }} onCreate={(title, roleId, deliverable, edgeType, srcStage, dstStage) => { const newId = `a-${Date.now()}`; createActivity(modalData.projectId, modalData.flowId, title, roleId, deliverable); setTimeout(() => createEdge(modalData.projectId, modalData.flowId, modalData.activityId, newId, edgeType, srcStage, dstStage), 50); setShowModal(null); setModalData({}); }} onCreateRole={createRole} onUpdateRole={updateRole} />}
        </>
      );
    }

    function WelcomeView({ onCreate }) {
      const [projectName, setProjectName] = useState('');
      const [team, setTeam] = useState('');
      const [userName, setUserName] = useState('');

      return (
        <div className="min-h-screen bg-gray-950 text-gray-100 flex items-center justify-center p-6">
          <div className="max-w-2xl w-full">
            <div className="text-center mb-12">
              <h1 className="text-4xl font-bold mb-4">EO</h1>
              <p className="text-gray-300 text-lg">Emergent Organizing</p>
            </div>
            <div className="bg-gray-900 rounded-lg border border-gray-800 p-8">
              <h2 className="text-xl font-semibold mb-6">Create Your First Project</h2>
              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm text-gray-200 mb-2">Project name</label>
                  <input type="text" value={projectName} onChange={(e) => setProjectName(e.target.value)} placeholder="e.g., Marketing, Product Development" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" />
                </div>
                <div>
                  <label className="block text-sm text-gray-200 mb-2">Team members (comma separated)</label>
                  <input type="text" value={team} onChange={(e) => setTeam(e.target.value)} placeholder="e.g., alex, pat, sam" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" />
                </div>
                <div>
                  <label className="block text-sm text-gray-200 mb-2">Your name</label>
                  <input type="text" value={userName} onChange={(e) => setUserName(e.target.value)} placeholder="Your name" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" />
                </div>
              </div>
              <button onClick={() => { if (projectName && userName) { const teamList = team ? team.split(',').map(s => s.trim()) : [userName]; onCreate(projectName, teamList, userName); } }} disabled={!projectName || !userName} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-medium py-3 rounded-lg transition-colors">Create Project</button>
            </div>
            <div className="bg-gray-900/50 rounded-lg border border-gray-800 p-6 mt-6">
              <p className="text-sm text-gray-300 leading-relaxed">Activities spawn new activities. Dependencies compute states. Structure emerges through action.</p>
            </div>
          </div>
        </div>
      );
    }

    function DashboardView({ projects, currentUser, roles, onSelectFlow, onCreateProject, onManageUsers, onCreateFlow }) {
      const allStats = useMemo(() => {
        let totalProjects = projects.length;
        let totalFlows = 0;
        let totalReady = 0;
        let totalWaiting = 0;
        let totalInProgress = 0;
        let totalCompleted = 0;

        projects.forEach(project => {
          totalFlows += project.flows.length;
          project.flows.forEach(flow => {
            flow.activities.forEach(activity => {
              const state = computeActivityState(activity, flow.activities, flow.edges, DEFAULT_DESTINATION_STAGE);
              if (state === 'ready') totalReady++;
              else if (state === 'waiting') totalWaiting++;
              else if (state === 'in_progress') totalInProgress++;
              else if (state === 'completed') totalCompleted++;
            });
          });
        });

        return { totalProjects, totalFlows, totalReady, totalWaiting, totalInProgress, totalCompleted };
      }, [projects]);

      const myWork = useMemo(() => {
        const work = [];
        projects.forEach(project => {
          project.flows.forEach(flow => {
            flow.activities.forEach(activity => {
              if (activity.claimedBy === currentUser && !activity.completedAt) {
                work.push({ project, flow, activity });
              }
            });
          });
        });
        return work;
      }, [projects, currentUser]);

      return (
        <div className="min-h-screen bg-gray-950 text-gray-100">
          <div className="border-b border-gray-800 bg-gray-900/50">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-2xl font-bold">EO</h1>
                  <p className="text-sm text-gray-400">Emergent Organizing</p>
                </div>
                <div className="flex items-center gap-4">
                  <div className="text-sm text-gray-300">You: {currentUser}</div>
                  <button onClick={onCreateProject} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                    <PlusIcon className="w-4 h-4" />New Project
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-6 py-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
              <div className="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div className="text-2xl font-bold text-blue-400">{allStats.totalProjects}</div>
                <div className="text-sm text-gray-400">Projects</div>
              </div>
              <div className="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div className="text-2xl font-bold text-purple-400">{allStats.totalFlows}</div>
                <div className="text-sm text-gray-400">Active Flows</div>
              </div>
              <div className="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div className="text-2xl font-bold text-green-400">{allStats.totalReady}</div>
                <div className="text-sm text-gray-400">Ready to Start</div>
              </div>
              <div className="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div className="text-2xl font-bold text-blue-400">{allStats.totalInProgress}</div>
                <div className="text-sm text-gray-400">In Progress</div>
              </div>
            </div>

            {myWork.length > 0 && (
              <div className="mb-8">
                <h2 className="text-xl font-semibold mb-4">My Active Work</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {myWork.map(({ project, flow, activity }) => (
                    <div key={activity.id} className="bg-gray-900 border border-blue-800 rounded-lg p-4 cursor-pointer hover:border-blue-700" onClick={() => onSelectFlow(project, flow)}>
                      <div className="text-xs text-gray-400 mb-2">{project.name} → {flow.name}</div>
                      <h4 className="font-medium mb-2">{activity.title}</h4>
                      <div className="flex items-center gap-2">
                        <span className="text-xs bg-blue-900 text-blue-300 px-2 py-1 rounded">In Progress</span>
                        {activity.priority && <span className="text-xs text-gray-400">Priority: {activity.priority}</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <h2 className="text-xl font-semibold mb-4">All Projects</h2>
            {projects.length === 0 ? (
              <div className="text-center py-20">
                <LayersIcon className="w-16 h-16 text-gray-600 mx-auto mb-4" />
                <p className="text-gray-400 mb-4">No projects yet</p>
                <button onClick={onCreateProject} className="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg transition-colors">Create Your First Project</button>
              </div>
            ) : (
              <div className="space-y-6">
                {projects.map(project => (
                  <ProjectCard key={project.id} project={project} roles={roles} onSelectFlow={(f) => onSelectFlow(project, f)} onManageUsers={() => onManageUsers(project)} onCreateFlow={() => onCreateFlow(project)} />
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    function ProjectCard({ project, roles, onSelectFlow, onManageUsers, onCreateFlow }) {
      return (
        <div className="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
          <div className="p-6 border-b border-gray-800">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-lg font-semibold">{project.name}</h3>
              <div className="flex gap-2">
                <button onClick={onManageUsers} className="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded transition-colors">
                  <UsersIcon className="w-3 h-3 inline mr-1" />Users
                </button>
                <button onClick={onCreateFlow} className="text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded transition-colors">
                  <PlusIcon className="w-3 h-3 inline mr-1" />Flow
                </button>
              </div>
            </div>
            <p className="text-sm text-gray-400">Team: {project.users.map(u => u.name).join(', ')} · {project.flows.length} flows</p>
          </div>
          
          {project.flows.length === 0 ? (
            <div className="p-6 text-center text-gray-400 text-sm">
              No flows yet. Create one to get started.
            </div>
          ) : (
            <div className="p-6 space-y-4">
              {project.flows.map(flow => (
                <FlowCard key={flow.id} flow={flow} roles={roles} onClick={() => onSelectFlow(flow)} />
              ))}
            </div>
          )}
        </div>
      );
    }

    function FlowCard({ flow, roles, onClick }) {
      const stats = useMemo(() => {
        let ready = 0, waiting = 0, inProgress = 0, completed = 0;
        flow.activities.forEach(activity => {
          const state = computeActivityState(activity, flow.activities, flow.edges, DEFAULT_DESTINATION_STAGE);
          if (state === 'ready') ready++;
          else if (state === 'waiting') waiting++;
          else if (state === 'in_progress') inProgress++;
          else if (state === 'completed') completed++;
        });
        return { ready, waiting, inProgress, completed };
      }, [flow]);

      return (
        <div className="bg-gray-800/50 rounded-lg p-4 border border-gray-700 cursor-pointer hover:border-gray-600 transition-colors" onClick={onClick}>
          <div className="flex items-start justify-between mb-3">
            <div>
              <h4 className="font-medium text-sm mb-1">{flow.name}</h4>
              <p className="text-xs text-gray-400">{flow.deliverables.join(' · ')}</p>
            </div>
            <div className="text-xs text-gray-400">{flow.activities.length} activities</div>
          </div>
          <div className="grid grid-cols-4 gap-2">
            <div className="bg-gray-900 rounded p-2">
              <div className="text-xs text-gray-400 mb-1">Ready</div>
              <div className="text-lg font-semibold text-green-400">{stats.ready}</div>
            </div>
            <div className="bg-gray-900 rounded p-2">
              <div className="text-xs text-gray-400 mb-1">Waiting</div>
              <div className="text-lg font-semibold text-yellow-400">{stats.waiting}</div>
            </div>
            <div className="bg-gray-900 rounded p-2">
              <div className="text-xs text-gray-400 mb-1">In Progress</div>
              <div className="text-lg font-semibold text-blue-400">{stats.inProgress}</div>
            </div>
            <div className="bg-gray-900 rounded p-2">
              <div className="text-xs text-gray-400 mb-1">Done</div>
              <div className="text-lg font-semibold text-gray-500">{stats.completed}</div>
            </div>
          </div>
        </div>
      );
    }

    function ActivitiesView({ project, flow, roles, currentUser, onBack, onCreateActivity, onEditActivity, onDeleteActivity, onClaimActivity, onUnclaimActivity, onCompleteActivity, onWireActivity, onRequestRevision, onAddComment, onAddAttachment, onRemoveAttachment, onMarkRead }) {
      const flowStages = useMemo(() => ensureFlowStages(flow), [flow]);
      const stageMap = useMemo(() => {
        const map = {};
        flowStages.forEach(stage => {
          map[stage.id] = stage;
        });
        return map;
      }, [flowStages]);
      const hasLegacyStageEdges = useMemo(() => flow.edges.some(edge => !edge.srcStage || !edge.dstStage), [flow.edges]);

      const activitiesWithState = useMemo(() => {
        return flow.activities.map(activity => ({
          ...activity,
          state: computeActivityState(activity, flow.activities, flow.edges, DEFAULT_DESTINATION_STAGE)
        }));
      }, [flow.activities, flow.edges]);

      const [selectedActivityId, setSelectedActivityId] = useState(null);

      const groupedActivities = useMemo(() => {
        const grouped = {};
        OPERATORS.forEach(op => {
          grouped[op.id] = activitiesWithState.filter(activity => {
            const role = roles.find(r => r.id === activity.roleId);
            return role?.operatorType === op.id;
          });
        });
        return grouped;
      }, [activitiesWithState, roles]);

      useEffect(() => {
        if (selectedActivityId && !activitiesWithState.some(a => a.id === selectedActivityId)) {
          setSelectedActivityId(null);
        }
      }, [activitiesWithState, selectedActivityId]);

      const selectedActivity = useMemo(() => {
        return selectedActivityId ? activitiesWithState.find(a => a.id === selectedActivityId) : null;
      }, [selectedActivityId, activitiesWithState]);

      const selectedRole = useMemo(() => {
        return selectedActivity ? roles.find(r => r.id === selectedActivity.roleId) : null;
      }, [selectedActivity, roles]);

      const selectedOperator = useMemo(() => {
        return selectedRole ? OPERATORS.find(op => op.id === selectedRole.operatorType) : null;
      }, [selectedRole]);

      const getDependencies = (activityId, stageFilter = null) => {
        const inbound = flow.edges
          .map(normalizeEdgeStages)
          .filter(e => e.dstId === activityId && (!stageFilter || e.dstStage === stageFilter));

        return inbound.map(edge => {
          const src = flow.activities.find(a => a.id === edge.srcId);
          if (!src) return null;

          const normalized = normalizeEdgeStages(edge);
          const srcStageDef = stageMap[normalized.srcStage];
          const dstStageDef = stageMap[normalized.dstStage];

          return {
            activity: src,
            edgeId: normalized.id,
            edgeType: normalized.type,
            srcStage: normalized.srcStage,
            dstStage: normalized.dstStage,
            srcStageLabel: stageNameForDisplay(srcStageDef) || normalized.srcStage,
            dstStageLabel: stageNameForDisplay(dstStageDef) || normalized.dstStage,
            srcStageDescription: srcStageDef?.description,
            dstStageDescription: dstStageDef?.description,
            srcStageScope: srcStageDef?.scope,
            dstStageScope: dstStageDef?.scope,
            isLegacyStage: normalized.__legacyStage,
            isSatisfied: isStageSatisfied(src, normalized.srcStage)
          };
        }).filter(Boolean);
      };

      const selectedDependencies = useMemo(() => {
        return selectedActivity ? getDependencies(selectedActivity.id) : [];
      }, [selectedActivity, flow.edges, flow.activities, stageMap]);

      const openActivityDetails = (activityId) => {
        setSelectedActivityId(activityId);
        if (currentUser) {
          onMarkRead(project.id, flow.id, activityId, currentUser);
        }
      };

      const closeDetails = () => {
        setSelectedActivityId(null);
      };

      return (
        <div className="min-h-screen bg-gray-950 text-gray-100">
          <div className="border-b border-gray-800 bg-gray-900/50">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex items-center justify-between">
                <button onClick={onBack} className="flex items-center gap-2 text-gray-300 hover:text-gray-100 transition-colors">
                  <HomeIcon className="w-4 h-4" />
                  Dashboard
                </button>
                <div className="text-sm text-gray-400">
                  {project.name} → {flow.name}
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-6">
            <div className="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-8">
              <div className="flex items-start justify-between mb-4">
                <div>
                  <h1 className="text-2xl font-bold mb-2">{flow.name}</h1>
                  {flow.description && <p className="text-gray-300">{flow.description}</p>}
                </div>
                <button onClick={() => onCreateActivity()} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                  <PlusIcon className="w-4 h-4" />New Activity
                </button>
              </div>
              <div>
                <div className="text-sm text-gray-300 mb-2">Flow Deliverables:</div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  {flow.deliverables.map((d, i) => (
                    <div key={i} className="bg-gray-800 rounded px-3 py-2 text-sm text-gray-200">{d}</div>
                  ))}
                </div>
              </div>
            </div>

            {hasLegacyStageEdges && (
              <div className="bg-yellow-900/30 border border-yellow-700/40 text-yellow-100 rounded-lg p-4 mb-6">
                <p className="text-sm">
                  Some existing dependencies are missing stage assignments. Rewire those connections to choose source and destination stages so readiness reflects accurately.
                </p>
              </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {OPERATORS.map(operator => (
                <div key={operator.id} className="bg-gray-900 border border-gray-800 rounded-lg p-4">
                  <div className="mb-4">
                    <div className="flex items-center justify-between mb-1">
                      <div className="flex items-center gap-2">
                        <h3 className="font-semibold">{operator.seq}. {operator.name}</h3>
                        <button onClick={() => onCreateActivity(operator.id)} className="p-1 rounded bg-gray-800/60 hover:bg-gray-700 transition-colors" title="Add activity">
                          <PlusIcon className="w-3.5 h-3.5" />
                        </button>
                      </div>
                      <span className="text-xs bg-gray-800 px-2 py-1 rounded">{groupedActivities[operator.id]?.length || 0}</span>
                    </div>
                    <p className="text-xs text-gray-300">{operator.desc}</p>
                  </div>
                  <div className="space-y-2">
                    {groupedActivities[operator.id]?.length === 0 ? (
                      <p className="text-sm text-gray-400 text-center py-4">No activities</p>
                    ) : (
                      groupedActivities[operator.id]?.map(activity => {
                        const role = roles.find(r => r.id === activity.roleId);
                        const deps = getDependencies(activity.id, DEFAULT_DESTINATION_STAGE);
                        return (
                          <ActivityCard
                            key={activity.id}
                            activity={activity}
                            role={role}
                            operator={operator}
                            dependencies={deps}
                            project={project}
                            currentUser={currentUser}
                            isSelected={selectedActivityId === activity.id}
                            onOpenDetails={openActivityDetails}
                            onEdit={onEditActivity}
                            onDelete={onDeleteActivity}
                            onClaim={onClaimActivity}
                            onUnclaim={onUnclaimActivity}
                            onComplete={onCompleteActivity}
                            onWire={onWireActivity}
                            onRequestRevision={onRequestRevision}
                          />
                        );
                      })
                    )}
                  </div>
                </div>
              ))}
            </div>
            {selectedActivity && (
              <ActivityDetailPanel
                activity={selectedActivity}
                role={selectedRole}
                operator={selectedOperator}
                dependencies={selectedDependencies}
                project={project}
                currentUser={currentUser}
                onClose={closeDetails}
                onEdit={onEditActivity}
                onDelete={onDeleteActivity}
                onClaim={onClaimActivity}
                onUnclaim={onUnclaimActivity}
                onComplete={onCompleteActivity}
                onWire={onWireActivity}
                onRequestRevision={onRequestRevision}
                onAddComment={(text) => currentUser && onAddComment(project.id, flow.id, selectedActivity.id, currentUser, text)}
                onAddAttachment={(attachment) => onAddAttachment(project.id, flow.id, selectedActivity.id, attachment)}
                onRemoveAttachment={(attachmentId) => onRemoveAttachment(project.id, flow.id, selectedActivity.id, attachmentId)}
              />
            )}
          </div>
        </div>
      );
    }

    function ActivityCard({ activity, role, operator, dependencies, project, currentUser, isSelected, onOpenDetails, onEdit, onDelete, onClaim, onUnclaim, onComplete, onWire, onRequestRevision }) {
      const isMine = activity.claimedBy === currentUser;
      const canClaim = activity.state === 'ready' && !activity.claimedBy && role?.userIds.some(uid => project.users.find(u => u.id === uid)?.name === currentUser);
      const canComplete = isMine && activity.state === 'in_progress';

      const stateConfig = {
        ready: { label: 'Ready to start', color: 'bg-green-900 text-green-300' },
        waiting: { label: 'Waiting', color: 'bg-yellow-900 text-yellow-300' },
        in_progress: { label: isMine ? 'You' : activity.claimedBy, color: isMine ? 'bg-blue-900 text-blue-300' : 'bg-gray-700 text-gray-300' },
        completed: { label: '✓ Done', color: 'bg-gray-700 text-gray-400' }
      };

      const config = stateConfig[activity.state] || stateConfig.ready;
      const commentCount = activity.comments?.length || 0;
      const attachmentCount = activity.attachments?.length || 0;
      const lastRead = activity.readBy?.[currentUser] || 0;
      const hasUnread = (activity.comments || []).some(comment => !comment.system && comment.createdAt > lastRead && comment.author !== currentUser);

      return (
        <div
          className={`bg-gray-800 border ${isSelected ? 'border-blue-500' : 'border-gray-700'} rounded-lg p-3 hover:border-blue-400 transition-colors cursor-pointer`}
          onClick={(e) => {
            if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input') || e.target.closest('textarea')) return;
            onOpenDetails(activity.id);
          }}
        >
          <div className="flex items-start justify-between mb-2">
            <h4 className="font-medium text-sm flex-1">{activity.title}</h4>
            <div className="flex items-center gap-1 ml-2">
              <span className={`text-xs px-2 py-0.5 rounded ${config.color}`}>{config.label}</span>
              {hasUnread && <span className="w-2 h-2 rounded-full bg-blue-400" title="Unread comments" />}
            </div>
          </div>
          {activity.isRevision && <div className="text-xs text-orange-400 mb-2">🔄 Revision requested</div>}
          {role && <div className="text-xs text-gray-300 mb-2">{role.name} • {role.userIds.map(uid => project.users.find(u => u.id === uid)?.name).filter(Boolean).join(', ')}</div>}
          {activity.deliverable && <div className="text-xs text-gray-200 mb-2"><span className="text-gray-400">Delivers:</span> {activity.deliverable}</div>}
          {dependencies.length > 0 && (
            <div className="text-xs text-gray-300 mb-2">
              <div className="text-gray-400 mb-1">Waiting on:</div>
              <ul className="space-y-0.5 ml-2">
                {dependencies.slice(0, 2).map((dep, i) => (
                  <li key={i} className="flex flex-wrap items-center gap-1">
                    <span className={`${dep.isSatisfied ? 'line-through text-gray-500' : ''}`}>
                      • {dep.dstStageLabel}: {dep.activity.title}
                    </span>
                    <span className="text-gray-500">({dep.srcStageLabel})</span>
                    {dep.edgeType === 'loops' && <span className="text-orange-400">(revision)</span>}
                    {dep.isLegacyStage && <span className="text-[10px] uppercase tracking-wide text-yellow-300 bg-yellow-900/40 px-1 py-0.5 rounded">Legacy</span>}
                  </li>
                ))}
                {dependencies.length > 2 && <li className="text-gray-400">+{dependencies.length - 2} more</li>}
              </ul>
            </div>
          )}
          <div className="flex items-center gap-3 text-xs text-gray-400 mt-3">
            {attachmentCount > 0 && (
              <div className="flex items-center gap-1"><span role="img" aria-label="attachments">📎</span>{attachmentCount}</div>
            )}
            {commentCount > 0 && (
              <div className="flex items-center gap-1"><ChatBubbleIcon className="w-3.5 h-3.5" />{commentCount}</div>
            )}
            {activity.createdAt && <div className="ml-auto text-gray-500">{formatRelativeTime(activity.createdAt)}</div>}
          </div>
          <div className="flex gap-1 mt-3 flex-wrap">
            {!activity.completedAt && (
              <>
                <button onClick={(e) => { e.stopPropagation(); onEdit(activity.id); }} className="bg-gray-700 hover:bg-gray-600 text-xs py-1 px-2 rounded transition-colors" title="Edit"><EditIcon className="w-3 h-3" /></button>
                <button onClick={(e) => { e.stopPropagation(); onDelete(activity.id); }} className="bg-red-900 hover:bg-red-800 text-xs py-1 px-2 rounded transition-colors" title="Delete"><TrashIcon className="w-3 h-3" /></button>
              </>
            )}
            {canClaim && <button onClick={(e) => { e.stopPropagation(); onClaim(activity.id); }} className="flex-1 bg-blue-600 hover:bg-blue-700 text-xs py-1 px-2 rounded transition-colors">Claim</button>}
            {isMine && !activity.completedAt && <button onClick={(e) => { e.stopPropagation(); onUnclaim(activity.id); }} className="bg-gray-700 hover:bg-gray-600 text-xs py-1 px-2 rounded transition-colors">Unclaim</button>}
            {canComplete && (
              <>
                <button onClick={(e) => { e.stopPropagation(); onComplete(activity.id); }} className="flex-1 bg-green-600 hover:bg-green-700 text-xs py-1 px-2 rounded transition-colors">Complete</button>
                {operator.canRequestRevision && dependencies.length > 0 && (
                  <button onClick={(e) => { e.stopPropagation(); const lastDep = dependencies[dependencies.length - 1]; if (lastDep) onRequestRevision(activity.id, lastDep.activity.id); }} className="bg-orange-600 hover:bg-orange-700 text-xs py-1 px-2 rounded transition-colors flex items-center justify-center gap-1" title="Request revision"><RefreshIcon className="w-3 h-3" /></button>
                )}
              </>
            )}
            {!activity.completedAt && <button onClick={(e) => { e.stopPropagation(); onWire(activity.id); }} className="bg-purple-600 hover:bg-purple-700 text-xs py-1 px-2 rounded transition-colors">Wire</button>}
          </div>
        </div>
      );
    }

    function ManageUsersModal({ project, onClose, onAddUser, onRemoveUser }) {
      const [newUserName, setNewUserName] = useState('');

      return (
        <Modal onClose={onClose} title="Manage Team Members">
          <div className="space-y-4">
            <div className="bg-blue-900/30 border border-blue-700/50 rounded p-4">
              <p className="text-sm text-gray-100">Add or remove team members. Users can be assigned to roles.</p>
            </div>
            <div>
              <label className="block text-sm text-gray-200 mb-2">Current Team</label>
              <div className="space-y-2">
                {project.users.map(user => (
                  <div key={user.id} className="flex items-center justify-between bg-gray-800 rounded px-4 py-2">
                    <span className="text-gray-100">{user.name}</span>
                    <button onClick={() => onRemoveUser(user.id)} className="text-red-400 hover:text-red-300 text-sm">Remove</button>
                  </div>
                ))}
              </div>
            </div>
            <div>
              <label className="block text-sm text-gray-200 mb-2">Add New User</label>
              <div className="flex gap-2">
                <input type="text" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} placeholder="User name" className="flex-1 bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" />
                <button onClick={() => { if (newUserName.trim()) { onAddUser(newUserName.trim()); setNewUserName(''); } }} disabled={!newUserName.trim()} className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 px-4 py-2 rounded transition-colors">Add</button>
              </div>
            </div>
            <div className="flex gap-3 pt-4">
              <button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Done</button>
            </div>
          </div>
        </Modal>
      );
    }

    function CreateProjectModal({ onClose, onCreate }) {
      const [name, setName] = useState('');
      const [team, setTeam] = useState('');
      return (
        <Modal onClose={onClose} title="Create Project">
          <div className="space-y-4">
            <div><label className="block text-sm text-gray-200 mb-2">Project name</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Marketing" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" autoFocus /></div>
            <div><label className="block text-sm text-gray-200 mb-2">Team members (comma separated)</label><input type="text" value={team} onChange={(e) => setTeam(e.target.value)} placeholder="e.g., alex, pat, sam" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
            <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={() => { if (name) { const teamList = team ? team.split(',').map(s => s.trim()) : []; onCreate(name, teamList); } }} disabled={!name} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 py-2 rounded transition-colors">Create</button></div>
          </div>
        </Modal>
      );
    }

    function CreateFlowModal({ onClose, onCreate }) {
      const [name, setName] = useState('');
      const [description, setDescription] = useState('');
      const [deliverables, setDeliverables] = useState(['', '', '']);
      return (
        <Modal onClose={onClose} title="Create Flow" size="large">
          <div className="space-y-4">
            <div className="bg-blue-900/30 border border-blue-700/50 rounded p-4"><p className="text-sm text-gray-100">Flows represent coordination cycles. Define up to three deliverables.</p></div>
            <div><label className="block text-sm text-gray-200 mb-2">Flow name</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Newsletter Creation" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" autoFocus /></div>
            <div><label className="block text-sm text-gray-200 mb-2">Description (optional)</label><textarea value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Brief description" rows={2} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-sm text-gray-100 placeholder-gray-400" /></div>
            <div><label className="block text-sm text-gray-200 mb-2">Flow Deliverables (1-3)</label><div className="space-y-2">{deliverables.map((d, i) => <input key={i} type="text" value={d} onChange={(e) => { const u = [...deliverables]; u[i] = e.target.value; setDeliverables(u); }} placeholder={i === 0 ? 'e.g., Published article' : i === 1 ? 'e.g., Social media package' : 'e.g., Analytics report'} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-sm text-gray-100 placeholder-gray-400" />)}</div></div>
            <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={() => { const valid = deliverables.filter(d => d.trim()); if (name && valid.length > 0) onCreate(name, valid, description); }} disabled={!name || !deliverables.some(d => d.trim())} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 py-2 rounded transition-colors">Create</button></div>
          </div>
        </Modal>
      );
    }

    function CreateActivityModal({ project, flow, roles, onClose, onCreate, onCreateRole, onUpdateRole, initialOperatorId }) {
      const [step, setStep] = useState('role');
      const [title, setTitle] = useState('');
      const [selectedRole, setSelectedRole] = useState('');
      const [newRoleName, setNewRoleName] = useState('');
      const [selectedOperator, setSelectedOperator] = useState(initialOperatorId || '');
      const [selectedUserIds, setSelectedUserIds] = useState([]);
      const [deliverable, setDeliverable] = useState('');

      useEffect(() => {
        setSelectedOperator(initialOperatorId || '');
        setSelectedRole('');
        setStep('role');
        setTitle('');
        setDeliverable('');
        setNewRoleName('');
        setSelectedUserIds([]);
      }, [initialOperatorId, project.id, flow.id]);

      const availableRoles = initialOperatorId ? roles.filter(r => r.operatorType === initialOperatorId) : roles;
      const operatorChoices = initialOperatorId ? OPERATORS.filter(op => op.id === initialOperatorId) : OPERATORS;

      const handleCreateRole = () => {
        if (newRoleName && selectedOperator) {
          const role = onCreateRole(newRoleName, selectedOperator, selectedUserIds);
          setSelectedRole(role.id);
          setStep('activity');
        }
      };

      const toggleUser = (userId) => {
        setSelectedUserIds(prev => prev.includes(userId) ? prev.filter(id => id !== userId) : [...prev, userId]);
      };

      return (
        <Modal onClose={onClose} title="Create Activity" size="large">
          <div className="space-y-4">
            {step === 'role' ? (
              <>
                <div className="bg-blue-900/30 border border-blue-700/50 rounded p-4 mb-4"><p className="text-sm text-gray-100">Each activity needs a role (who does it) and operator type (what kind of work).</p></div>
                {availableRoles.length > 0 && (
                  <>
                    <div><label className="block text-sm text-gray-200 mb-2">Select existing role</label><select value={selectedRole} onChange={(e) => setSelectedRole(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="">Choose...</option>{availableRoles.map(r => { const op = OPERATORS.find(o => o.id === r.operatorType); return <option key={r.id} value={r.id}>{r.name} ({op?.name})</option>; })}</select></div>
                    {selectedRole && <button onClick={() => setStep('activity')} className="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded transition-colors">Continue</button>}
                    <div className="relative"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-700"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-gray-900 text-gray-300">or create new role</span></div></div>
                  </>
                )}
                <div><label className="block text-sm text-gray-200 mb-2">New role name</label><input type="text" value={newRoleName} onChange={(e) => setNewRoleName(e.target.value)} placeholder="e.g., Content Writer" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
                <div><label className="block text-sm text-gray-200 mb-2">Select operator type</label><div className="grid grid-cols-3 gap-2">{operatorChoices.map(op => <button key={op.id} onClick={() => setSelectedOperator(op.id)} className={`p-3 border rounded text-left transition-colors ${selectedOperator === op.id ? 'border-blue-500 bg-blue-500/20' : 'border-gray-700 hover:border-gray-600'}`}><div className="font-medium text-sm">{op.seq}. {op.name}</div><div className="text-xs text-gray-300 mt-1">{op.desc}</div></button>)}</div></div>
                <div><label className="block text-sm text-gray-200 mb-2">Assign users to this role</label><div className="space-y-2">{project.users.map(user => <label key={user.id} className="flex items-center gap-3 p-3 bg-gray-800 border border-gray-700 rounded cursor-pointer hover:border-gray-600"><input type="checkbox" checked={selectedUserIds.includes(user.id)} onChange={() => toggleUser(user.id)} /><span className="text-sm text-gray-100">{user.name}</span></label>)}</div></div>
                <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={handleCreateRole} disabled={!newRoleName || !selectedOperator} className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-700 py-2 rounded transition-colors">Create Role & Continue</button></div>
              </>
            ) : (
              <>
                <div className="bg-gray-800 rounded p-3 mb-4"><div className="text-sm text-gray-300">Role: {roles.find(r => r.id === selectedRole)?.name}</div><button onClick={() => setStep('role')} className="text-xs text-blue-400 hover:text-blue-300 mt-1">Change</button></div>
                <div><label className="block text-sm text-gray-200 mb-2">Activity name</label><input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g., Write article" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" autoFocus /></div>
                <div><label className="block text-sm text-gray-200 mb-2">Deliverable (optional)</label><input type="text" value={deliverable} onChange={(e) => setDeliverable(e.target.value)} placeholder="e.g., 800-word article" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
                <div className="flex gap-3 pt-4"><button onClick={() => setStep('role')} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Back</button><button onClick={() => { if (title && selectedRole) onCreate(title, selectedRole, deliverable); }} disabled={!title} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 py-2 rounded transition-colors">Create</button></div>
              </>
            )}
          </div>
        </Modal>
      );
    }

    function EditActivityModal({ project, activity, roles, onClose, onUpdate, onCreateRole, onUpdateRole }) {
      const [title, setTitle] = useState(activity?.title || '');
      const [deliverable, setDeliverable] = useState(activity?.deliverable || '');
      const [selectedRole, setSelectedRole] = useState(activity?.roleId || '');

      useEffect(() => {
        if (activity) {
          setTitle(activity.title);
          setDeliverable(activity.deliverable || '');
          setSelectedRole(activity.roleId);
        }
      }, [activity]);

      return (
        <Modal onClose={onClose} title="Edit Activity">
          <div className="space-y-4">
            <div><label className="block text-sm text-gray-200 mb-2">Activity name</label><input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g., Write article" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" autoFocus /></div>
            <div><label className="block text-sm text-gray-200 mb-2">Role</label><select value={selectedRole} onChange={(e) => setSelectedRole(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="">Choose...</option>{roles.map(r => { const op = OPERATORS.find(o => o.id === r.operatorType); return <option key={r.id} value={r.id}>{r.name} ({op?.name})</option>; })}</select></div>
            <div><label className="block text-sm text-gray-200 mb-2">Deliverable (optional)</label><input type="text" value={deliverable} onChange={(e) => setDeliverable(e.target.value)} placeholder="e.g., 800-word article" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
            <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={() => { if (title && selectedRole) onUpdate({ title, roleId: selectedRole, deliverable }); }} disabled={!title || !selectedRole} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 py-2 rounded transition-colors">Save</button></div>
          </div>
        </Modal>
      );
    }

    function DeleteActivityModal({ activity, onClose, onDelete }) {
      return (
        <Modal onClose={onClose} title="Delete Activity">
          <div className="space-y-4">
            <div className="bg-red-900/30 border border-red-700/50 rounded p-4">
              <p className="text-sm text-gray-100">Are you sure you want to delete this activity? This will also remove all edges connected to it. This action cannot be undone.</p>
            </div>
            <div className="bg-gray-900 rounded-lg p-4">
              <h3 className="font-medium text-gray-100">{activity?.title}</h3>
            </div>
            <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={onDelete} className="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded transition-colors">Delete</button></div>
          </div>
        </Modal>
      );
    }

    function ClaimActivityModal({ activity, roles, project, onClose, onClaim }) {
      const [priority, setPriority] = useState('medium');
      return (
        <Modal onClose={onClose} title="Claim Activity">
          <div className="space-y-4">
            <div className="bg-gray-900 rounded-lg p-4"><h3 className="font-medium mb-2 text-gray-100">{activity?.title}</h3></div>
            <div><label className="block text-sm text-gray-200 mb-3">Priority</label><div className="space-y-2">{[{ value: 'high', label: 'High - Focus' }, { value: 'medium', label: 'Medium - Normal' }, { value: 'low', label: 'Low - When available' }].map(opt => <label key={opt.value} className="flex items-center gap-3 p-3 bg-gray-800 border border-gray-700 rounded cursor-pointer hover:border-gray-600"><input type="radio" name="priority" value={opt.value} checked={priority === opt.value} onChange={(e) => setPriority(e.target.value)} /><span className="text-sm text-gray-100">{opt.label}</span></label>)}</div></div>
            <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={() => onClaim(priority)} className="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded transition-colors">Claim</button></div>
          </div>
        </Modal>
      );
    }

    function CompleteActivityModal({ project, activity, flow, roles, onClose, onComplete, onCreateRole, onUpdateRole }) {
      const [spawnNext, setSpawnNext] = useState(false);
      const [nextTitle, setNextTitle] = useState('');
      const [nextRoleId, setNextRoleId] = useState('');
      const [nextDeliverable, setNextDeliverable] = useState('');
      const [showNewRole, setShowNewRole] = useState(false);
      const [newRoleName, setNewRoleName] = useState('');
      const [newRoleOperator, setNewRoleOperator] = useState('');
      const [selectedUserIds, setSelectedUserIds] = useState([]);

      const handleCreateRole = () => {
        if (newRoleName && newRoleOperator) {
          const role = onCreateRole(newRoleName, newRoleOperator, selectedUserIds);
          setNextRoleId(role.id);
          setShowNewRole(false);
        }
      };

      const toggleUser = (userId) => {
        setSelectedUserIds(prev => prev.includes(userId) ? prev.filter(id => id !== userId) : [...prev, userId]);
      };

      return (
        <Modal onClose={onClose} title="Complete Activity" size="large">
          <div className="space-y-4">
            <div className="bg-gray-900 rounded-lg p-4"><h3 className="font-medium text-gray-100">{activity?.title}</h3></div>
            <div className="bg-blue-900/30 border border-blue-700/50 rounded p-4"><label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" checked={spawnNext} onChange={(e) => setSpawnNext(e.target.checked)} className="w-4 h-4" /><span className="text-sm text-gray-100">Spawn next activity (what does this enable?)</span></label></div>
            {spawnNext && (
              <>
                <div><label className="block text-sm text-gray-200 mb-2">Next activity title</label><input type="text" value={nextTitle} onChange={(e) => setNextTitle(e.target.value)} placeholder="e.g., Review article" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
                {!showNewRole ? (
                  <>
                    <div><label className="block text-sm text-gray-200 mb-2">Role for next activity</label><select value={nextRoleId} onChange={(e) => setNextRoleId(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="">Choose...</option>{roles.map(r => { const op = OPERATORS.find(o => o.id === r.operatorType); return <option key={r.id} value={r.id}>{r.name} ({op?.name})</option>; })}</select></div>
                    <button onClick={() => setShowNewRole(true)} className="text-sm text-blue-400 hover:text-blue-300">+ Create new role</button>
                  </>
                ) : (
                  <>
                    <div><label className="block text-sm text-gray-200 mb-2">New role name</label><input type="text" value={newRoleName} onChange={(e) => setNewRoleName(e.target.value)} placeholder="e.g., Editor" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
                    <div><label className="block text-sm text-gray-200 mb-2">Operator type</label><select value={newRoleOperator} onChange={(e) => setNewRoleOperator(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="">Choose...</option>{OPERATORS.map(op => <option key={op.id} value={op.id}>{op.seq}. {op.name}</option>)}</select></div>
                    <div><label className="block text-sm text-gray-200 mb-2">Assign users</label><div className="space-y-2">{project.users.map(user => <label key={user.id} className="flex items-center gap-3 p-3 bg-gray-800 border border-gray-700 rounded cursor-pointer hover:border-gray-600"><input type="checkbox" checked={selectedUserIds.includes(user.id)} onChange={() => toggleUser(user.id)} /><span className="text-sm text-gray-100">{user.name}</span></label>)}</div></div>
                    <div className="flex gap-2"><button onClick={handleCreateRole} disabled={!newRoleName || !newRoleOperator} className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-700 py-2 rounded transition-colors">Create Role</button><button onClick={() => setShowNewRole(false)} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button></div>
                  </>
                )}
                <div><label className="block text-sm text-gray-200 mb-2">Deliverable (optional)</label><input type="text" value={nextDeliverable} onChange={(e) => setNextDeliverable(e.target.value)} placeholder="e.g., Reviewed article" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
              </>
            )}
            <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={() => { onComplete(spawnNext && nextTitle && nextRoleId ? { title: nextTitle, roleId: nextRoleId, deliverable: nextDeliverable } : null); }} disabled={spawnNext && (!nextTitle || !nextRoleId)} className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-700 py-2 rounded transition-colors">Complete</button></div>
          </div>
        </Modal>
      );
    }

    function WireActivityModal({ project, activity, flow, roles, onClose, onWire, onCreate, onCreateRole, onUpdateRole }) {
      const [mode, setMode] = useState('existing');
      const [targetId, setTargetId] = useState('');
      const [edgeType, setEdgeType] = useState('enables');
      const [newTitle, setNewTitle] = useState('');
      const [newRoleId, setNewRoleId] = useState('');
      const [newDeliverable, setNewDeliverable] = useState('');
      const [showNewRole, setShowNewRole] = useState(false);
      const [newRoleName, setNewRoleName] = useState('');
      const [newRoleOperator, setNewRoleOperator] = useState('');
      const [selectedUserIds, setSelectedUserIds] = useState([]);
      const flowStages = useMemo(() => ensureFlowStages(flow), [flow]);
      const sourceStageOptions = useMemo(() => flowStages.filter(stage => stage.scope === 'source' || stage.scope === 'both'), [flowStages]);
      const destinationStageOptions = useMemo(() => flowStages.filter(stage => stage.scope === 'destination' || stage.scope === 'both'), [flowStages]);
      const [sourceStage, setSourceStage] = useState(sourceStageOptions[0]?.id || DEFAULT_SOURCE_STAGE);
      const [destinationStage, setDestinationStage] = useState(destinationStageOptions[0]?.id || DEFAULT_DESTINATION_STAGE);
      const hasLegacyStageEdges = useMemo(() => flow.edges.some(edge => !edge.srcStage || !edge.dstStage), [flow.edges]);

      const availableActivities = flow.activities.filter(a => a.id !== activity.id && !a.completedAt);

      const handleCreateRole = () => {
        if (newRoleName && newRoleOperator) {
          const role = onCreateRole(newRoleName, newRoleOperator, selectedUserIds);
          setNewRoleId(role.id);
          setShowNewRole(false);
        }
      };

      const toggleUser = (userId) => {
        setSelectedUserIds(prev => prev.includes(userId) ? prev.filter(id => id !== userId) : [...prev, userId]);
      };

      useEffect(() => {
        if (!sourceStageOptions.some(stage => stage.id === sourceStage)) {
          setSourceStage(sourceStageOptions[0]?.id || DEFAULT_SOURCE_STAGE);
        }
      }, [sourceStageOptions, sourceStage]);

      useEffect(() => {
        if (!destinationStageOptions.some(stage => stage.id === destinationStage)) {
          setDestinationStage(destinationStageOptions[0]?.id || DEFAULT_DESTINATION_STAGE);
        }
      }, [destinationStageOptions, destinationStage]);

      const selectedSourceStage = sourceStageOptions.find(stage => stage.id === sourceStage);
      const selectedDestinationStage = destinationStageOptions.find(stage => stage.id === destinationStage);

      return (
        <Modal onClose={onClose} title="Wire Activity" size="large">
          <div className="space-y-4">
            <div className="bg-gray-900 rounded-lg p-4"><h3 className="font-medium text-gray-100">{activity?.title}</h3><p className="text-sm text-gray-300 mt-1">Connect this activity to another</p></div>
            {hasLegacyStageEdges && (
              <div className="bg-yellow-900/30 border border-yellow-700/40 text-yellow-100 rounded p-3 text-sm">
                Some existing connections still need stage assignments. New wires require selecting both source and destination stages.
              </div>
            )}
            <div><label className="block text-sm text-gray-200 mb-2">Connection type</label><select value={edgeType} onChange={(e) => setEdgeType(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="enables">Enables (this unlocks the other)</option><option value="requires">Requires (this depends on the other)</option></select></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm text-gray-200 mb-2">Source stage</label>
                <select value={sourceStage} onChange={(e) => setSourceStage(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100">
                  {sourceStageOptions.map(stage => (
                    <option key={stage.id} value={stage.id}>{stageNameForDisplay(stage)} ({stageScopeLabel(stage.scope)})</option>
                  ))}
                </select>
                {selectedSourceStage?.description && <p className="text-xs text-gray-400 mt-1">{selectedSourceStage.description}</p>}
              </div>
              <div>
                <label className="block text-sm text-gray-200 mb-2">Destination stage</label>
                <select value={destinationStage} onChange={(e) => setDestinationStage(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100">
                  {destinationStageOptions.map(stage => (
                    <option key={stage.id} value={stage.id}>{stageNameForDisplay(stage)} ({stageScopeLabel(stage.scope)})</option>
                  ))}
                </select>
                {selectedDestinationStage?.description && <p className="text-xs text-gray-400 mt-1">{selectedDestinationStage.description}</p>}
              </div>
            </div>
            <div className="flex gap-2 p-2 bg-gray-800 rounded"><button onClick={() => setMode('existing')} className={`flex-1 py-2 px-3 rounded text-sm transition-colors ${mode === 'existing' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`}>Existing Activity</button><button onClick={() => setMode('new')} className={`flex-1 py-2 px-3 rounded text-sm transition-colors ${mode === 'new' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`}>Create New</button></div>
            {mode === 'existing' ? (
              <>
                <div><label className="block text-sm text-gray-200 mb-2">Select activity</label><select value={targetId} onChange={(e) => setTargetId(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="">Choose...</option>{availableActivities.map(a => <option key={a.id} value={a.id}>{a.title}</option>)}</select></div>
                <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={() => { if (targetId && sourceStage && destinationStage) onWire(targetId, edgeType, sourceStage, destinationStage); }} disabled={!targetId || !sourceStage || !destinationStage} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 py-2 rounded transition-colors">Wire</button></div>
              </>
            ) : (
              <>
                <div><label className="block text-sm text-gray-200 mb-2">New activity title</label><input type="text" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} placeholder="e.g., Review article" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
                {!showNewRole ? (
                  <>
                    <div><label className="block text-sm text-gray-200 mb-2">Role</label><select value={newRoleId} onChange={(e) => setNewRoleId(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="">Choose...</option>{roles.map(r => { const op = OPERATORS.find(o => o.id === r.operatorType); return <option key={r.id} value={r.id}>{r.name} ({op?.name})</option>; })}</select></div>
                    <button onClick={() => setShowNewRole(true)} className="text-sm text-blue-400 hover:text-blue-300">+ Create new role</button>
                  </>
                ) : (
                  <>
                    <div><label className="block text-sm text-gray-200 mb-2">New role name</label><input type="text" value={newRoleName} onChange={(e) => setNewRoleName(e.target.value)} placeholder="e.g., Editor" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
                    <div><label className="block text-sm text-gray-200 mb-2">Operator type</label><select value={newRoleOperator} onChange={(e) => setNewRoleOperator(e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100"><option value="">Choose...</option>{OPERATORS.map(op => <option key={op.id} value={op.id}>{op.seq}. {op.name}</option>)}</select></div>
                    <div><label className="block text-sm text-gray-200 mb-2">Assign users</label><div className="space-y-2">{project.users.map(user => <label key={user.id} className="flex items-center gap-3 p-3 bg-gray-800 border border-gray-700 rounded cursor-pointer hover:border-gray-600"><input type="checkbox" checked={selectedUserIds.includes(user.id)} onChange={() => toggleUser(user.id)} /><span className="text-sm text-gray-100">{user.name}</span></label>)}</div></div>
                    <div className="flex gap-2"><button onClick={handleCreateRole} disabled={!newRoleName || !newRoleOperator} className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-700 py-2 rounded transition-colors">Create Role</button><button onClick={() => setShowNewRole(false)} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button></div>
                  </>
                )}
                <div><label className="block text-sm text-gray-200 mb-2">Deliverable (optional)</label><input type="text" value={newDeliverable} onChange={(e) => setNewDeliverable(e.target.value)} placeholder="e.g., Reviewed draft" className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-gray-100 placeholder-gray-400" /></div>
                <div className="flex gap-3 pt-4"><button onClick={onClose} className="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">Cancel</button><button onClick={() => { if (newTitle && newRoleId && sourceStage && destinationStage) onCreate(newTitle, newRoleId, newDeliverable, edgeType, sourceStage, destinationStage); }} disabled={!newTitle || !newRoleId || !sourceStage || !destinationStage} className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 py-2 rounded transition-colors">Create & Wire</button></div>
              </>
            )}
          </div>
        </Modal>
      );
    }

    function Modal({ children, onClose, title, size = 'medium' }) {
      const sizeClasses = { medium: 'max-w-2xl', large: 'max-w-4xl' };
      return (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-6 z-50">
          <div className={`bg-gray-900 rounded-lg border border-gray-800 w-full ${sizeClasses[size]} max-h-[90vh] overflow-y-auto`}>
            <div className="sticky top-0 bg-gray-900 border-b border-gray-800 p-6 flex items-center justify-between">
              <h2 className="text-xl font-semibold text-gray-100">{title}</h2>
              <button onClick={onClose} className="text-gray-300 hover:text-gray-100 transition-colors"><XIcon className="w-5 h-5" /></button>
            </div>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<EventOperator />);
  </script>
</body>
</html>
